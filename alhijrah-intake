<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>بوابة الهجرة الذكية – Alhijrah Visa & Immigration Services</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Lite libs -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- EmailJS -->
  <script defer src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    :root{
      --gold:#ffd700; --gold2:#ffe483; --blue:#0b1e4d; --blue2:#04294a; --ink:#f5deb3; --line:#ffffff2a;
    }
    *{box-sizing:border-box}
    body{font-family:'Cairo',sans-serif;margin:0;background:linear-gradient(135deg,var(--blue),var(--blue2));color:var(--ink);padding-bottom:74px}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:auto;padding:28px}
    .card{background:rgba(3,23,58,.95);border:1px solid var(--line);border-radius:16px;box-shadow:0 0 20px #daa52055;padding:22px;animation:fadeIn .4s ease}
    h1{margin:0 0 6px;color:var(--gold);text-shadow:0 0 8px var(--gold)}
    h2{margin:0 0 12px;color:var(--gold2)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .row{display:grid;gap:12px}
    .col-2{grid-template-columns:1fr 1fr}
    .col-3{grid-template-columns:repeat(3,1fr)}
    @media(max-width:840px){.col-2,.col-3{grid-template-columns:1fr}}
    select,input,textarea{width:100%;background:#0b1e4d;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px;outline-color:var(--gold);transition:box-shadow .2s}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 12px #ffd700aa}
    label{display:block;margin:.35rem 0 .2rem;font-weight:700}
    button{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;transition:transform .08s}
    button:active{transform:translateY(1px)}
    .btn{background:var(--gold);color:#04294a}
    .btn.sec{background:#0b1e4d;color:#fff;border:1px solid var(--line)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .hint{color:#ffe59a;font-size:.95rem;margin:.25rem 0 .6rem}
    .muted{opacity:.85;font-size:.95rem}
    .progress{height:8px;background:#ffffff1a;border-radius:8px;overflow:hidden;margin:10px 0 16px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--gold),var(--gold2));transition:width .25s}
    .services{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:12px;background:#041c3f}
    .svc{background:#0c2a6b;border:1px solid var(--line);border-radius:10px;padding:10px 12px;margin:6px 0;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .svc:hover{background:var(--gold);color:#04294a;box-shadow:0 0 12px #ffd700}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:#0b1e4d;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0}
    .files{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .file{border:1px solid var(--line);border-radius:10px;padding:6px 10px;background:#0b1e4d}
    .toast{position:fixed;top:14px;left:50%;transform:translateX(-50%);background:#05224a;color:#ffd700;border:1px solid #ffd70066;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:1300;display:none}
    .loading{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1250;display:none}
    .loading .box{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#041c3f;border:1px solid var(--line);border-radius:14px;padding:16px 18px;box-shadow:0 10px 28px rgba(0,0,0,.45)}
    .spinner{width:22px;height:22px;border:3px solid #fff3;border-top-color:var(--gold);border-radius:50%;display:inline-block;animation:spin 1s linear infinite;margin-inline-end:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Social left */
    .social-left{position:fixed;left:12px;top:50%;transform:translateY(-50%);z-index:1000}
    .social-left .stack{display:flex;flex-direction:column;gap:10px}
    .social-left a{width:44px;height:44px;display:grid;place-items:center;border-radius:12px;background:rgba(255,255,255,.12);border:1px solid var(--line);color:#fff;transition:transform .15s, box-shadow .25s}
    .social-left a:hover{transform:translateY(-2px);box-shadow:0 10px 26px rgba(0,0,0,.35)}

    /* Footer (VIP) */
    footer{margin-top:40px}
    .footer-vip{position:relative;overflow:hidden;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.16);box-shadow:0 20px 50px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.08);backdrop-filter:blur(12px)}
    .footer-vip .glow{position:absolute;inset:-2px;border-radius:20px;background:conic-gradient(from 180deg,rgba(255,215,0,.35),rgba(57,255,20,.15),transparent 40%,rgba(0,230,230,.18));filter:blur(24px);opacity:.6;pointer-events:none}
    .footer-inner{max-width:1100px;margin:auto;padding:24px}
    .footer-grid{display:grid;gap:16px;grid-template-columns:2fr 1.3fr 1.3fr 1.6fr}
    @media(max-width:980px){.footer-grid{grid-template-columns:1fr 1fr}} @media(max-width:640px){.footer-grid{grid-template-columns:1fr}}
    .footer-title{color:#ffe483;font-weight:900;letter-spacing:.4px;margin-bottom:8px;text-shadow:0 0 12px rgba(255,215,0,.35)}
    .footer-box{background:rgba(11,30,77,.55);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;box-shadow:inset 0 0 18px rgba(255,255,255,.04)}
    .footer-links a{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);margin:7px 0}
    .footer-cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .badge-vip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,215,0,.5);background:linear-gradient(180deg,rgba(255,215,0,.18),rgba(255,255,255,.02));color:#ffd700;font-weight:800;font-size:.95rem}
    .copy{margin-top:8px;opacity:.9}

    /* Ticker */
    .ticker{position:fixed;left:0;right:0;bottom:0;z-index:1200;padding:8px 0;backdrop-filter:blur(10px)}
    .ticker .wrap{max-width:1240px;margin:auto;padding:0 14px;border:1px solid rgba(255,255,255,.16);border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));box-shadow:0 -12px 30px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.08);position:relative;overflow:hidden}
    .ticker .wrap::before{content:"";position:absolute;inset:-2px;border-radius:16px;background:conic-gradient(from 90deg,rgba(255,215,0,.35),rgba(0,230,230,.18),transparent 40%);filter:blur(18px);opacity:.45;pointer-events:none}
    .ticker-row{display:flex;gap:10px;align-items:center;padding:10px 8px}
    .ticker-icon{color:#ffd700;font-size:1.1rem}
    .marquee{overflow:hidden;white-space:nowrap;flex:1}
    .marquee-line{display:inline-block;padding-left:40px;animation:marquee 40s linear infinite}
    .marquee:hover .marquee-line{animation-play-state:paused}
    @keyframes marquee{from{transform:translateX(0)}to{transform:translateX(-50%)}}
    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;margin:0 8px;border-radius:999px;border:1px dashed rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .tag i{color:#ffe483}

    /* Client Card */
    #clientCard{position:relative;border-radius:22px;overflow:hidden;margin-top:20px;background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.16);box-shadow:0 16px 44px rgba(0,0,0,.45);display:none}
    #clientCard .neon{content:"";position:absolute;inset:-2px;border-radius:24px;z-index:0;background:conic-gradient(from 180deg,rgba(255,215,0,.55),rgba(0,230,230,.35),transparent 40%,rgba(57,255,20,.35));filter:blur(22px);opacity:.7;pointer-events:none}
    #clientCard .inner{position:relative;z-index:1}
    .card-head{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .avatar.vip{width:110px;height:110px;border-radius:50%;object-fit:cover;border:3px solid #ffd700;box-shadow:0 0 20px rgba(255,215,0,.35),inset 0 0 18px rgba(255,255,255,.25);background:#fff}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);color:#ffe483;border-radius:999px;padding:6px 10px;font-weight:800}
    .kv{display:grid;gap:8px;grid-template-columns:repeat(2,1fr)}
    @media(max-width:700px){.kv{grid-template-columns:1fr}}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    /* Photo capture */
    .photo-box{background:rgba(255,255,255,.05);border:1px dashed rgba(255,255,255,.25);border-radius:14px;padding:10px}
    #cam{width:100%;border-radius:12px;display:none; transform: scaleX(-1);} /* mirror ONLY preview */
    #photoCanvas{width:100%;max-height:320px;border-radius:12px;display:none;background:#fff}
    .photo-hint{font-size:.95rem;color:#ffe59a}

    /* Hide Jotform controls in UI (kept in code for future use) */
    #btnJotPrefill, #btnJotTable, #btnJotBoard, #jotHint { display:none !important; }
  </style>
</head>
<body>

<!-- Social icons left -->
<div class="social-left" aria-label="روابط التواصل">
  <div class="stack card" style="padding:8px">
    <a href="https://wa.me/13139194272" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
    <a href="mailto:visa@alhijrahservices.com" title="Email"><i class="fa-solid fa-envelope"></i></a>
    <a href="https://alhijrahvisa.com" target="_blank" title="Website"><i class="fa-solid fa-globe"></i></a>
    <a href="https://www.facebook.com/share/19gTVpmjVo/" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
    <a href="https://www.instagram.com/alhijrahservices/" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="toolbar" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <h1 id="title">بوابة الهجرة الذكية – Alhijrah Visa & Immigration Services</h1>
      <div>
        <label for="lang" class="muted" style="display:inline-block;margin-inline-end:6px">اللغة / Language</label>
        <select id="lang" style="width:auto">
          <option value="ar" selected>العربية</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>
    <p id="tagline" class="muted" style="margin-top:0">
      مرحبًا بكم في المنصة الرسمية لـ <b>Alhijrah Visa & Immigration Services</b> — تجربة هجرة متكاملة واحترافية.
    </p>

    <div class="progress"><div id="bar" class="bar"></div></div>

    <!-- Step 1 -->
    <section id="step1">
      <div class="row col-3">
        <div class="colspan">
          <label id="labelCountry" for="country">الدولة/التصنيف</label>
          <select id="country" required>
            <option value="" selected disabled>— اختر —</option>
            <option value="usa">الولايات المتحدة</option>
            <option value="canada">كندا</option>
            <option value="australia">أستراليا</option>
            <option value="newzealand">نيوزيلندا</option>
            <option value="yemen">اليمن</option>
            <option value="translation">الترجمة</option>
            <option value="notarization">التوثيق</option>
            <option value="powerofattorney">التوكيل والتعميد</option>
            <option value="hajj">الحج والعمرة</option>
            <option value="flights">حجوزات الطيران</option>
          </select>
          <div id="hintCountry" class="hint">اختر التصنيف ثم ابحث أو اختر من القائمة. جميع الخدمات تستخدم نفس النموذج.</div>
        </div>
        <div class="colspan">
          <label id="labelSearch" for="svcSearch">بحث عن خدمة</label>
          <input id="svcSearch" placeholder="اكتب مثلًا: تجديد الجرين كارد، التأشيرة السياحية…" />
        </div>
        <div class="toolbar" style="align-self:end">
          <button id="next1" class="btn">التالي →</button>
        </div>
      </div>

      <div class="services" id="svcBox" aria-live="polite" aria-atomic="true" style="margin-top:10px">
        <div id="svcMuted" class="muted">سيتم عرض الخدمات هنا بعد اختيار التصنيف أو كتابة كلمة بحث…</div>
        <div id="svcList"></div>
      </div>
    </section>

    <!-- Step 2 -->
    <section id="step2" style="display:none">
      <h2 id="formTitle">نموذج تقديم الطلب</h2>
      <div class="pill"><b id="labelServiceBold">الخدمة:</b>&nbsp;<span id="svcNamePill">—</span></div>
      <div id="reqDocs" class="hint"></div>

      <div class="row col-2" style="margin-top:8px">
        <div>
          <label id="labelFullName" for="fullName">الاسم الكامل *</label>
          <input id="fullName" required placeholder="الاسم كما في الجواز" />
        </div>
        <div>
          <label id="labelEmail" for="email">البريد الإلكتروني *</label>
          <input id="email" type="email" required placeholder="example@mail.com" />
        </div>
        <div>
          <label id="labelPhone" for="phone">رقم الهاتف *</label>
          <input id="phone" required placeholder="+1313XXXXXXXX أو 00966XXXXXXX" />
          <div id="hintPhone" class="hint">يُسمح بصيغة + أو 00، 8–15 رقم.</div>
        </div>
        <div>
          <label id="labelCity" for="city">المدينة (اختياري)</label>
          <input id="city" placeholder="مثلاً: الرياض، ديربورن…" />
        </div>
        <div>
          <label id="labelCitizenship" for="citizenship">الجنسية *</label>
          <input id="citizenship" required placeholder="مثلاً: اليمنية / السعودية / الأمريكية…" />
        </div>
        <div>
          <label id="labelResident" for="residentCountry">بلد الإقامة *</label>
          <input id="residentCountry" required placeholder="الدولة التي تقيم فيها حالياً" />
        </div>
      </div>

      <label id="labelDetails" for="details">تفاصيل إضافية (اختياري)</label>
      <textarea id="details" rows="4" placeholder="اكتب أي معلومات تساعدنا (تواريخ، أرقام إيصالات، ملاحظات)…"></textarea>

      <label id="labelFiles" for="files">إرفاق مستندات (اختياري)</label>
      <input id="files" type="file" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" />
      <div class="muted" id="fileMeta">لم يتم إرفاق ملفات بعد.</div>
      <div class="files" id="fileList"></div>

      <!-- Smart Photo Capture -->
      <div class="photo-box" style="margin-top:10px">
        <label id="labelPhoto">صورة شخصية 600×600 (تلقائي)</label>
        <div class="toolbar" style="margin:6px 0 8px">
          <input id="avatarInput" type="file" accept="image/*" />
          <button id="btnCamStart" class="btn sec" type="button"><i class="fa-solid fa-camera"></i> <span id="bCam">تشغيل الكاميرا</span></button>
          <button id="btnCamShot" class="btn sec" type="button" disabled><i class="fa-solid fa-bullseye"></i> <span id="bShot">التقاط</span></button>
          <button id="btnAnalyze" class="btn" type="button" disabled><i class="fa-solid fa-wand-magic-sparkles"></i> <span id="bAnalyze">فحص/تحسين</span></button>
        </div>
        <video id="cam" autoplay playsinline></video>
        <canvas id="photoCanvas"></canvas>
        <div id="photoReport" class="photo-hint"></div>
        <div id="photoHint" class="photo-hint">* إذا لم يسمح المتصفح بالكاميرا (يتطلب HTTPS)، استخدم الرفع اليدوي.</div>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <button id="prev2" class="btn sec">رجوع</button>
        <button id="next2" class="btn">مراجعة →</button>
      </div>
    </section>

    <!-- Step 3 -->
    <section id="step3" style="display:none">
      <h2 id="reviewTitle">مراجعة الطلب</h2>
      <div id="reviewBox" class="card" style="background:#041c3f"></div>
      <div class="toolbar" style="margin-top:10px">
        <button id="prev3" class="btn sec">تعديل</button>
        <button id="submit" class="btn">تأكيد الإرسال</button>
      </div>

      <!-- Jotform controls (hidden via CSS) -->
      <div class="toolbar" id="jotControls" style="margin-top:10px; justify-content:flex-start">
        <a id="btnJotPrefill" class="btn sec" target="_blank" rel="noopener"><i class="fa-solid fa-up-right-from-square"></i> <span id="bJotOpen">فتح نموذج Jotform (معبأ)</span></a>
        <a id="btnJotTable" class="btn sec" target="_blank" rel="noopener"><i class="fa-solid fa-table"></i> Jotform Table</a>
        <a id="btnJotBoard" class="btn sec" target="_blank" rel="noopener"><i class="fa-solid fa-grip"></i> Jotform Board</a>
      </div>
      <div id="jotHint" class="hint">الاسم المُركّب (الاسم الأول/الأخير) مُفعّل للـ Jotform Prefill.</div>
    </section>

    <!-- Client Card -->
    <section id="clientCard" class="card">
      <div class="neon"></div>
      <div class="inner">
        <h2 id="cardTitle" style="margin-top:0">بطاقة العميل الرقمية (VIP)</h2>
        <div class="card-head">
          <img class="avatar vip" id="avatar" src="https://via.placeholder.com/110x110.png?text=AL" alt="Applicant Photo"/>
          <div class="chips">
            <span class="chip"><i class="fa-solid fa-hashtag"></i> <span id="cTrack">TrackID:</span> <span id="trackId">—</span></span>
            <span class="chip"><i class="fa-solid fa-star"></i> <span id="cService">الخدمة:</span> <span id="svcOut">—</span></span>
            <span class="chip"><i class="fa-solid fa-shield-halved"></i> <span id="cSecure">محمي</span></span>
          </div>
          <div id="qrcode" style="margin-inline-start:auto"></div>
        </div>

        <div class="kv" id="cardData" style="margin-top:10px"></div>

        <div class="actions">
          <button id="dlPDF" class="btn"><i class="fa-solid fa-file-arrow-down"></i> <span id="bPDF">تنزيل PDF</span></button>
          <button id="dlWord" class="btn sec"><i class="fa-solid fa-file-word"></i> <span id="bWord">تنزيل Word</span></button>
          <a id="waShare" class="btn sec" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> <span id="bWA">مشاركة واتساب</span></a>
          <button id="printCard" class="btn sec"><i class="fa-solid fa-print"></i> <span id="bPrint">طباعة</span></button>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- Footer -->
<footer>
  <div class="footer-vip">
    <div class="glow"></div>
    <div class="footer-inner">
      <div class="footer-grid">
        <div class="footer-box">
          <div class="footer-title" id="fBrand">Alhijrah Visa & Immigration Services</div>
          <div class="muted" id="fTag">واجهة زجاجية ذكية — تجربة VIP موثوقة واحترافية.</div>
          <div class="footer-cta">
            <span class="badge-vip"><i class="fa-solid fa-crown"></i> VIP</span>
            <span class="badge-vip"><i class="fa-solid fa-shield-halved"></i> Secure</span>
            <span class="badge-vip"><i class="fa-solid fa-bolt"></i> Smart Portal</span>
          </div>
        </div>

        <div class="footer-box footer-links">
          <div class="footer-title" id="fContact">تواصل</div>
          <a href="https://wa.me/13139194272" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp: +1 (313) 919-4272</a>
          <a href="mailto:visa@alhijrahservices.com"><i class="fa-solid fa-envelope"></i> visa@alhijrahservices.com</a>
          <a href="tel:+13139194272"><i class="fa-solid fa-phone"></i> +1 (313) 919-4272</a>
        </div>

        <div class="footer-box footer-links">
          <div class="footer-title" id="fLinks">روابط</div>
          <a href="https://alhijrahvisa.com" target="_blank"><i class="fa-solid fa-globe"></i> Official Site</a>
          <a href="https://www.facebook.com/share/19gTVpmjVo/" target="_blank"><i class="fab fa-facebook-f"></i> Facebook</a>
          <a href="https://www.instagram.com/alhijrahservices/" target="_blank"><i class="fab fa-instagram"></i> Instagram</a>
        </div>

        <div class="footer-box">
          <div class="footer-title" id="fBooking">حجوزات واستشارات</div>
          <div class="muted" id="fHours">استشارات يوميًا 10 ص – 6 م (EST)</div>
          <div class="footer-cta" style="margin-top:6px">
            <a class="btn" href="https://calendly.com/alhijrahservices-info/professional-consultation-alhijrah-immigration?month=2025-08" target="_blank" rel="noopener"><i class="fa-solid fa-calendar-days"></i> <span id="fBook">احجز الآن</span></a>
            <a class="btn sec" href="mailto:visa@alhijrahservices.com"><i class="fa-solid fa-envelope"></i> <span id="fEmailUs">راسلنا</span></a>
          </div>
        </div>
      </div>
      <div class="copy">© <span id="yr"></span> Alhijrah Services — جميع الحقوق محفوظة.</div>
    </div>
  </div>
</footer>

<!-- Toast + Loading -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="loading" class="loading"><div class="box"><span class="spinner"></span><span id="loadingText">جارٍ تجهيز بياناتك…</span></div></div>

<!-- Thank You Overlay -->
<div id="thanksWrap" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1200">
  <div id="thanksCard" class="card" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);max-width:560px;width:90%;text-align:center;animation:pop .35s ease">
    <h2 id="thanksTitle">🎉 شكرًا لك!</h2>
    <p id="thanksDesc" style="margin:.5rem 0 1rem">تم استلام طلبك بنجاح. سنراجع بياناتك ونتواصل معك قريبًا.</p>
    <div class="toolbar" style="justify-content:center">
      <button id="btnViewCard" class="btn">عرض بطاقة العميل</button>
      <button id="btnCloseThanks" class="btn sec">إغلاق</button>
    </div>
  </div>
</div>

<!-- VIP Glass Ticker -->
<div class="ticker" aria-label="شريط خدمات وتواصل">
  <div class="wrap">
    <div class="ticker-row">
      <i class="fa-solid fa-bullhorn ticker-icon"></i>
      <div class="marquee">
        <div class="marquee-line" id="tickerLine">
          <!-- Filled by JS for current language -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const INTEGRATIONS = {
  EMAILJS: {
    PUBLIC_KEY: "0Cub6o0xkk9eYTe90",
    SERVICE_ID: "service_flhs3e5",
    TEMPLATE_ID: "template_mguzw2l",
    TO_EMAIL: "Jobs@alhijrahservices.com"
  },
  APPS_SCRIPT: {
    ENDPOINT: "https://script.google.com/macros/s/AKfycbzN07vwQbkeixwM4WGnfiODt6uzUQMFCJ-AyxtFZ2oGX0603YqiMw1xUlq-v5UG4xtf/exec"
  },
  JOTFORM: {
    FORM_URL: "https://form.jotform.com/AlhijrahServices/Alhijrahsmartportal",
    BOARD_URL: "https://www.jotform.com/boards/252149440362049",
    TABLE_URL: "https://www.jotform.com/tables/250817936172058",
    FIELD_MAP: {
      "name[first]": "first_name",
      "name[last]": "last_name",
      "email": "email",
      "phone": "phone",
      "city": "city",
      "service": "service",
      "citizenship": "citizenship",
      "resident_country": "resident_country",
      "trackId": "track_id"
    },
    AUTO_OPEN_ON_SUBMIT: false // keep users on-site
  }
};

const TEXT = {
  ar: {
    ui: {
      title: "بوابة الهجرة الذكية – Alhijrah Visa & Immigration Services",
      tagline: "مرحبًا بكم في المنصة الرسمية — تجربة هجرة متكاملة واحترافية.",
      countryLabel: "الدولة/التصنيف",
      countryHint: "اختر التصنيف ثم ابحث أو اختر من القائمة. جميع الخدمات تستخدم نفس النموذج.",
      searchLabel: "بحث عن خدمة",
      next: "التالي →",
      formTitle: "نموذج تقديم الطلب",
      serviceBold: "الخدمة:",
      fullName: "الاسم الكامل *",
      email: "البريد الإلكتروني *",
      phone: "رقم الهاتف *",
      city: "المدينة (اختياري)",
      citizenship: "الجنسية *",
      resident: "بلد الإقامة *",
      details: "تفاصيل إضافية (اختياري)",
      attach: "إرفاق مستندات (اختياري)",
      phoneHint: "يُسمح بصيغة + أو 00، 8–15 رقم.",
      photoLabel: "صورة شخصية 600×600 (تلقائي)",
      bCam: "تشغيل الكاميرا", bShot: "التقاط", bAnalyze:"فحص/تحسين",
      photoHint: "* إذا لم يسمح المتصفح بالكاميرا (يتطلب HTTPS)، استخدم الرفع اليدوي.",
      back: "رجوع", reviewGo: "مراجعة →",
      reviewTitle: "مراجعة الطلب",
      edit: "تعديل", submit: "تأكيد الإرسال",
      jotOpen: "فتح نموذج Jotform (معبأ)",
      jotHint: "الاسم المُركّب (الاسم الأول/الأخير) مُفعّل للـ Jotform Prefill.",
      cardTitle: "بطاقة العميل الرقمية (VIP)",
      cTrack: "TrackID:", cService:"الخدمة:", cSecure:"محمي",
      bPDF:"تنزيل PDF", bWA:"مشاركة واتساب", bPrint:"طباعة",
      thanksTitle:"🎉 شكرًا لك!", thanksDesc:"تم استلام طلبك بنجاح. سنراجع بياناتك ونتواصل معك قريبًا.",
      load:"جارٍ تجهيز بياناتك…",
      fBrand:"Alhijrah Visa & Immigration Services",
      fTag:"واجهة زجاجية ذكية — تجربة VIP موثوقة واحترافية.",
      fContact:"تواصل", fLinks:"روابط", fBooking:"حجوزات واستشارات", fHours:"استشارات يوميًا 10 ص – 6 م (EST)", fBook:"احجز الآن", fEmailUs:"راسلنا",
      svcEmpty:"سيتم عرض الخدمات هنا بعد اختيار التصنيف أو كتابة كلمة بحث…",
      svcNoMatch:"لا نتائج مطابقة للبحث.",
      chooseFirst:"اختر التصنيف أولاً.", chooseService:"اختر خدمة من القائمة.",
      checkRequired:"تحقق من الاسم والبريد والهاتف والجنسية وبلد الإقامة.",
      toastChosen:"تم اختيار الخدمة: ",
      ticker: [
        "خدمات USCIS العائلية والوظيفية",
        "جوازات السفر الأمريكية واليمنية",
        "البطاقات الخضراء والتجديد",
        "مواعيد سفارات وتأشيرات",
        "ترجمة قانونية وتوثيق ووكالات",
        "حجوزات طيران وتأمين سفر",
        "استشارات قانونية — VIP"
      ]
    },
    services: {
      usa: [
        {ar:"لمّ شمل الأسرة", en:"Family Sponsorship"},
        {ar:"تعديل الحالة داخل أمريكا", en:"Adjustment of Status"},
        {ar:"تصاريح العمل", en:"Work Authorization"},
        {ar:"تصريح سفر/إعادة دخول", en:"Advance Parole / Reentry"},
        {ar:"تعهد مالي للدعم", en:"Affidavit of Support"},
        {ar:"تغيير/تمديد حالة زائر", en:"Change/Extend Status"},
        {ar:"تأشيرة خطوبة/زواج", en:"Fiancé(e)/Marriage (K-1/K-3)"},
        {ar:"إزالة شرط الإقامة", en:"Remove Conditions"},
        {ar:"تجديد/استبدال الجرين كارد", en:"Green Card Renewal/Replacement"},
        {ar:"التجنس بالجنسية", en:"Naturalization"},
        {ar:"شهادة الجنسية", en:"Certificate of Citizenship"},
        {ar:"إعفاءات ومخالفات", en:"Waivers"},
        {ar:"تصاريح إعادة التقديم", en:"Permission to Reapply"},
        {ar:"الحماية المؤقتة", en:"Temporary Protected Status"},
        {ar:"برنامج دكا (حيث ينطبق)", en:"DACA"},
        {ar:"طلب السجل (FOIA)", en:"FOIA Records"},
        {ar:"اللجوء والإجراءات المرتبطة", en:"Asylum Support"},
        {ar:"إصدار/تجديد جواز أمريكي", en:"U.S. Passport – New/Renewal"},
        {ar:"تقرير ولادة بالخارج", en:"Consular Report of Birth Abroad"},
        {ar:"خدمات قنصلية/توثيق", en:"Consular/Notarial Appointments"},
        {ar:"تأشيرة زيارة/سياحة/أعمال", en:"Visitor/Tourist/Business Visa"},
        {ar:"تأشيرة دراسة", en:"Student Visa"},
        {ar:"تأشيرات تبادل/عمل متخصص/شركة", en:"Exchange/Skilled/Intracompany"},
        {ar:"تأشيرات كفاءات/مستثمر", en:"Extraordinary Ability/Investor"},
        {ar:"تأشيرات عبور/طاقم/دينية", en:"Transit/Crew/Religious"},
        {ar:"المعالجة القنصلية للهجرة", en:"Immigrant Consular Processing"},
        {ar:"متابعة موافقات قديمة", en:"Follow-to-Join / Action on Approval"},
        {ar:"تغيير عنوان السجلات", en:"Address Change"},
        {ar:"استفسارات وتصحيح بيانات", en:"Records Correction & Inquiries"}
      ],
      canada: [
        {ar:"الدخول السريع – عمال مهرة", en:"Express Entry"},
        {ar:"برامج الترشيح الإقليمي", en:"Provincial Nominee Program"},
        {ar:"تصريح دراسة", en:"Study Permit"},
        {ar:"تصريح عمل", en:"Work Permit"},
        {ar:"رعاية عائلية", en:"Family Sponsorship"},
        {ar:"تأشيرة زائر / eTA", en:"Visitor Visa / eTA"},
        {ar:"تجديد بطاقة الإقامة الدائمة", en:"PR Card Renewal"}
      ],
      australia: [
        {ar:"هجرة مهارية", en:"Skilled Migration"},
        {ar:"تأشيرة طالب", en:"Student Visa"},
        {ar:"زائر/سياحة", en:"Visitor Visa"},
        {ar:"أسرة/شريك", en:"Partner/Parent"},
        {ar:"عمل مؤقت", en:"Temporary Work"}
      ],
      newzealand: [
        {ar:"عمل/مهارات", en:"Skilled/Work"},
        {ar:"طالب", en:"Student"},
        {ar:"زائر", en:"Visitor"},
        {ar:"أسرة/شريك", en:"Family/Partner"}
      ],
      yemen: [
        {ar:"إصدار جواز", en:"New Passport"},
        {ar:"تجديد جواز", en:"Passport Renewal"},
        {ar:"الإقامات", en:"Residency Services"},
        {ar:"السجلات المدنية", en:"Civil Records"}
      ],
      translation: [
        {ar:"ترجمة قانونية معتمدة", en:"Certified Legal Translation"},
        {ar:"ترجمة شهادات/عقود", en:"Certificates/Contracts"},
        {ar:"ختم وتوثيق ترجمة", en:"Stamped & Notarized"}
      ],
      notarization: [
        {ar:"توثيق وتسجيل العقود", en:"Contract Notarization"},
        {ar:"التصديق على التوقيعات", en:"Signature Attestation"}
      ],
      powerofattorney: [
        {ar:"وكالة عامة", en:"General Power of Attorney"},
        {ar:"وكالة خاصة/تعميد", en:"Special POA / Apostille"}
      ],
      hajj: [
        {ar:"حج باقات كاملة", en:"Hajj Packages"},
        {ar:"عمرة وتنقلات", en:"Umrah & Transport"},
        {ar:"إقامة وخدمات", en:"Accommodation Services"}
      ],
      flights: [
        {ar:"تذاكر دولية", en:"International Tickets"},
        {ar:"تذاكر داخلية", en:"Domestic Tickets"},
        {ar:"تعديل/إلغاء", en:"Change/Cancel"},
        {ar:"مجموعات وعوائل", en:"Groups & Families"}
      ]
    }
  },
  en: {
    ui: {
      title: "Smart Immigration Portal – Alhijrah Visa & Immigration Services",
      tagline: "Welcome to the official platform — a complete, professional immigration experience.",
      countryLabel: "Country / Category",
      countryHint: "Pick a category then search or choose from the list. One smart form for all services.",
      searchLabel: "Search for a service",
      next: "Next →",
      formTitle: "Application Form",
      serviceBold: "Service:",
      fullName: "Full Name *",
      email: "Email *",
      phone: "Phone *",
      city: "City (optional)",
      citizenship: "Citizenship *",
      resident: "Resident Country *",
      details: "Additional Details (optional)",
      attach: "Attach Documents (optional)",
      phoneHint: "Formats + or 00 allowed, 8–15 digits.",
      photoLabel: "Passport Photo 600×600 (auto)",
      bCam:"Start Camera", bShot:"Capture", bAnalyze:"Analyze/Enhance",
      photoHint: "* If browser blocks camera (HTTPS required), use manual upload.",
      back: "Back", reviewGo:"Review →",
      reviewTitle:"Review Submission",
      edit:"Edit", submit:"Submit",
      jotOpen:"Open Prefilled Jotform",
      jotHint:"Structured name (First/Last) enabled for Jotform prefill.",
      cardTitle:"Digital Client Card (VIP)",
      cTrack:"TrackID:", cService:"Service:", cSecure:"Secured",
      bPDF:"Download PDF", bWA:"Share via WhatsApp", bPrint:"Print",
      thanksTitle:"🎉 Thank you!", thanksDesc:"Your request was received. We'll review and contact you shortly.",
      load:"Preparing your data…",
      fBrand:"Alhijrah Visa & Immigration Services",
      fTag:"Glass UI — VIP, secure and professional.",
      fContact:"Contact", fLinks:"Links", fBooking:"Bookings & Consultations", fHours:"Daily 10am–6pm (EST)", fBook:"Book now", fEmailUs:"Email us",
      svcEmpty:"Services will appear after selecting a category or typing a search…",
      svcNoMatch:"No matching services.",
      chooseFirst:"Choose a category first.",
      chooseService:"Pick a service from the list.",
      checkRequired:"Please verify name, email, phone, citizenship, and resident country.",
      toastChosen:"Selected service: ",
      ticker: [
        "USCIS family & employment services",
        "US & Yemen passports",
        "Green cards & renewals",
        "Embassy appointments & visas",
        "Legal translation, notarization, POA",
        "Flight bookings & travel insurance",
        "Legal consultations — VIP"
      ]
    },
    services: {} // uses Arabic lists but displays en names
  }
};

/* ================= Data & State ================= */
const MAX_FILE = 5*1024*1024;
const OK_EXT = ['pdf','doc','docx','jpg','jpeg','png'];

let LANG = 'ar';
let selectedService = null;

/* ================= Elements (with safe getters) ================= */
const $ = (id)=>document.getElementById(id);
const yr = $('yr'); yr.textContent = new Date().getFullYear();

const bar = $('bar');
const step1 = $('step1'), step2 = $('step2'), step3 = $('step3');
const country = $('country'), svcSearch = $('svcSearch'), svcBox = $('svcBox'), svcList = $('svcList'), svcMuted = $('svcMuted'), next1 = $('next1');

const fullName = $('fullName'), email = $('email'), phone = $('phone'), city = $('city'),
      citizenship = $('citizenship'), residentCountry = $('residentCountry'),
      details = $('details'), files = $('files'), fileList = $('fileList'), fileMeta = $('fileMeta'),
      prev2 = $('prev2'), next2 = $('next2');

const svcNamePill = $('svcNamePill'), reqDocs = $('reqDocs');
const reviewBox = $('reviewBox'), prev3 = $('prev3'), submitBtn = $('submit');

const clientCard = $('clientCard'), trackIdEl=$('trackId'), svcOut=$('svcOut'),
      qrcodeEl=$('qrcode'), cardData=$('cardData'), dlPDF=$('dlPDF'), dlWord=$('dlWord'), waShare=$('waShare'), printCard=$('printCard');

const toast = $('toast');
const thanksWrap = $('thanksWrap'), btnViewCard=$('btnViewCard'), btnCloseThanks=$('btnCloseThanks');
const loading = $('loading'), loadingText = $('loadingText');

/* Language-controlled elements */
const langSel = $('lang');
const L = (k)=>TEXT[LANG].ui[k];

/* ================= Language Switch ================= */
function applyLang(){
  document.documentElement.lang = LANG;
  document.documentElement.dir = (LANG==='ar'?'rtl':'ltr');

  // Head title fix
  document.title = L('title');

  // Labels & texts
  $('title').textContent = L('title'); // H1
  $('tagline').textContent = L('tagline');
  $('labelCountry').textContent = L('countryLabel');
  $('hintCountry').textContent = L('countryHint');
  $('labelSearch').textContent = L('searchLabel');
  next1.textContent = L('next');

  $('formTitle').textContent = L('formTitle');
  $('labelServiceBold').textContent = L('serviceBold');
  $('labelFullName').textContent = L('fullName');
  $('labelEmail').textContent = L('email');
  $('labelPhone').textContent = L('phone');
  $('labelCity').textContent = L('city');
  $('labelCitizenship').textContent = L('citizenship');
  $('labelResident').textContent = L('resident');
  $('labelDetails').textContent = L('details');
  $('labelFiles').textContent = L('attach');
  $('hintPhone').textContent = L('phoneHint');
  $('labelPhoto').textContent = L('photoLabel');
  $('bCam').textContent = L('bCam');
  $('bShot').textContent = L('bShot');
  $('bAnalyze').textContent = L('bAnalyze');
  $('photoHint').textContent = L('photoHint');

  $('prev2').textContent = L('back');
  $('next2').textContent = L('reviewGo');

  $('reviewTitle').textContent = L('reviewTitle');
  $('prev3').textContent = L('edit');
  $('submit').textContent = L('submit');
  $('bJotOpen').textContent = L('jotOpen');
  $('jotHint').textContent = L('jotHint');

  $('cardTitle').textContent = L('cardTitle');
  $('cTrack').textContent = L('cTrack');
  $('cService').textContent = L('cService');
  $('cSecure').textContent = L('cSecure');
  $('bPDF').textContent = L('bPDF');
  $('bWA').textContent = L('bWA');
  $('bPrint').textContent = L('bPrint');
  $('bWord').textContent = (LANG==='ar'?'تنزيل Word':'Download Word');

  $('thanksTitle').textContent = L('thanksTitle');
  $('thanksDesc').textContent = L('thanksDesc');
  $('loadingText').textContent = L('load');

  $('fBrand').textContent = L('fBrand');
  $('fTag').textContent = L('fTag');
  $('fContact').textContent = L('fContact');
  $('fLinks').textContent = L('fLinks');
  $('fBooking').textContent = L('fBooking');
  $('fHours').textContent = L('fHours');
  $('fBook').textContent = L('fBook');
  $('fEmailUs').textContent = L('fEmailUs');

  svcMuted.textContent = L('svcEmpty');

  // fill ticker
  const tags = L('ticker');
  $('tickerLine').innerHTML = tags.concat(tags).map(t => `<span class="tag"><i class="fa-solid fa-star-of-life"></i> ${t}</span>`).join('');

  // refresh services list
  renderServices();
}
langSel.addEventListener('change', ()=>{ LANG = langSel.value; applyLang(); });

/* ================= Services ================= */
function getServicesForCountry(){
  const c = country.value;
  if(!c) return [];
  const arr = TEXT.ar.services[c] || [];
  return arr.map(s => ({ n: (LANG==='ar' ? s.ar : s.en), req: [] }));
}
function renderServices(){
  const list = getServicesForCountry();
  const q = (svcSearch.value||'').trim().toLowerCase();
  let filt = list;
  if(q){ filt = list.filter(s => s.n.toLowerCase().includes(q)); }
  svcList.innerHTML = '';
  if(!country.value){ svcMuted.textContent = L('svcEmpty'); return; }
  if(filt.length===0){ svcMuted.textContent = L('svcNoMatch'); return; }
  svcMuted.textContent = '';
  filt.forEach(s=>{
    const row = document.createElement('div'); row.className='svc';
    const span = document.createElement('span'); span.textContent = s.n;
    const btn = document.createElement('button'); btn.className='btn sec'; btn.textContent=(LANG==='ar'?'اختيار':'Select');
    btn.onclick = ()=> selectService(s);
    row.append(span, btn);
    svcList.appendChild(row);
  });
}
country.addEventListener('change', renderServices);
svcSearch.addEventListener('input', debounce(renderServices, 200));

function selectService(svc){
  selectedService = svc;
  $('svcNamePill').textContent = svc.n;
  $('reqDocs').innerHTML = "";
  setStep(1);
  showToast(L('toastChosen') + svc.n);
}

/* ================= Navigation & Validation ================= */
function setStep(i){
  const steps=[step1,step2,step3];
  steps.forEach((s,idx)=> s.style.display = idx===i ? 'block' : 'none');
  bar.style.width = (i/(steps.length-1))*100 + '%';
  window.scrollTo({top:0,behavior:'smooth'});
}
$('next1').addEventListener('click', ()=>{
  if(!country.value){ showToast(L('chooseFirst')); return; }
  if(!selectedService){ showToast(L('chooseService')); return; }
  setStep(1);
});
$('prev2').addEventListener('click', ()=> setStep(0));
$('next2').addEventListener('click', ()=>{
  if(!v('fullName') || !($('email')?.validity?.valid) || !phoneValid(v('phone')) || !v('citizenship') || !v('residentCountry')){
    showToast(L('checkRequired'));
    return;
  }
  buildReview();
  setStep(2);
});
$('prev3').addEventListener('click', ()=> setStep(1));

function v(id){ const el=$(id); return (el && typeof el.value==='string') ? el.value.trim() : ""; }
function phoneValid(val){ return /^(\+|00)?\d{8,15}$/.test((val||'').trim()); }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ================= Review ================= */
function buildReview(){
  const det = esc(v('details')).replace(/\n/g,'<br>');
  const fileNames = [...(files?.files||[])].map(f=>`<li>${esc(f.name)}</li>`).join('');
  const filesHTML = (files && files.files && files.files.length) ? `<ul>${fileNames}</ul>` : (LANG==='ar'?'لا يوجد':'None');
  reviewBox.innerHTML = `
    <p><b>${L('serviceBold')}</b> ${esc(selectedService?.n||'—')}</p>
    <p><b>${L('fullName').replace(' *','')}:</b> ${esc(v('fullName'))}</p>
    <p><b>${L('email').replace(' *','')}:</b> ${esc(v('email'))}</p>
    <p><b>${L('phone').replace(' *','')}:</b> ${esc(v('phone'))}</p>
    <p><b>${L('city').replace(' (اختياري)','').replace(' (optional)','')}:</b> ${esc(v('city')||'-')}</p>
    <p><b>${L('citizenship').replace(' *','')}:</b> ${esc(v('citizenship'))}</p>
    <p><b>${L('resident').replace(' *','')}:</b> ${esc(v('residentCountry'))}</p>
    <p><b>${L('details').replace(' (اختياري)','').replace(' (optional)','')}:</b></p><div>${det|| (LANG==='ar'?'لا يوجد':'None')}</div>
    <p><b>${L('attach').replace(' (اختياري)','').replace(' (optional)','')}:</b> ${filesHTML}</p>
  `;
  $('btnJotPrefill').href = buildJotPrefillURL();
  $('btnJotTable').href   = INTEGRATIONS.JOTFORM.TABLE_URL;
  $('btnJotBoard').href   = INTEGRATIONS.JOTFORM.BOARD_URL;
}

/* ================= Submit ================= */
$('submit').addEventListener('click', async ()=>{
  const track = makeTrackId();
  thanksWrap.style.display='block';
  showClientCard(track);
  loadingOn();

  try{
    const payload = buildPayload(track);
    await fireIntegrations(payload);
  }catch(e){
    console.warn('Integrations error', e);
    showToast((LANG==='ar'?'تعذر إرسال بعض البيانات.':'Some data could not be sent.'));
  }finally{
    loadingOff();
  }
});
$('btnViewCard').onclick = ()=>{ thanksWrap.style.display='none'; clientCard.scrollIntoView({behavior:'smooth', block:'center'}); };
$('btnCloseThanks').onclick = ()=>{ thanksWrap.style.display='none'; };

function makeTrackId(){
  const d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return `ALH-${y}${m}${dd}-${Math.floor(Math.random()*9000+1000)}`;
}

/* ================= Client Card ================= */
function showClientCard(track){
  trackIdEl.textContent = track;
  svcOut.textContent = selectedService?.n || '—';

  const qrText = location.origin + location.pathname + '?track=' + encodeURIComponent(track);
  qrcodeEl.innerHTML = ''; new QRCode(qrcodeEl, {text:qrText, width:120, height:120, colorDark:"#000", colorLight:"#fff"});

  cardData.innerHTML = `
    <div class="footer-box">
      <p><b>${L('fullName').replace(' *','')}:</b> ${esc(v('fullName'))}</p>
      <p><b>${L('citizenship').replace(' *','')}:</b> ${esc(v('citizenship'))}</p>
      <p><b>${L('resident').replace(' *','')}:</b> ${esc(v('residentCountry'))}</p>
    </div>
    <div class="footer-box">
      <p><b>${L('email').replace(' *','')}:</b> ${esc(v('email'))}</p>
      <p><b>${L('phone').replace(' *','')}:</b> ${esc(v('phone'))}</p>
      <p><b>${L('city').replace(' (اختياري)','').replace(' (optional)','')}:</b> ${esc(v('city')||'-')}</p>
      <p><b>${LANG==='ar'?'التاريخ':'Date'}:</b> ${new Date().toLocaleDateString(LANG==='ar'?'ar':'en')}</p>
    </div>
  `;

  clientCard.style.display = 'block';
  waShare.href = `https://wa.me/13139194272?text=${encodeURIComponent('TrackID '+track+' — '+(v('fullName')||'')+' — '+(selectedService?.n||''))}`;
  dlPDF.onclick = ()=> html2pdf().from(clientCard).set({margin:.4, filename:`ClientCard_${track}.pdf`, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a4'}}).save();
  dlWord.onclick = ()=> downloadWordFromCard(track);
  printCard.onclick = ()=> window.print();
}

/* ======= Word (.doc) export (HTML-in-DOC, opens in Microsoft Word) ======= */
function downloadWordFromCard(track){
  // Build a minimal, RTL-aware HTML doc for Word
  const html = `
<!DOCTYPE html><html ${LANG==='ar'?'lang="ar" dir="rtl"':'lang="en" dir="ltr"'}>
<head><meta charset="utf-8"><title>Client Card ${track}</title></head>
<body>
  <h2>${esc(L('cardTitle'))}</h2>
  <div>${clientCard.querySelector('.inner').innerHTML}</div>
  <hr/>
  <p><small>Generated from Alhijrah Smart Portal — TrackID: ${esc(track)}</small></p>
</body></html>`;
  const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ClientCard_${track}.doc`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 800);
}

/* ================= Jotform Prefill (kept for future) ================= */
function splitNameSmart(full){
  const clean = (full||"").trim().replace(/\s+/g,' ');
  if(!clean) return {first:"", last:""};
  const parts = clean.split(' ');
  if(parts.length===1) return {first:parts[0], last:""};
  return {first:parts[0], last:parts.slice(1).join(' ')};
}
function buildJotPrefillURL(track){
  const params = new URLSearchParams();
  const F = INTEGRATIONS.JOTFORM.FIELD_MAP || {};
  const full = v('fullName');
  const {first, last} = splitNameSmart(full);
  const trySet = (key, val) => { if(key && val!=null) params.set(key, val); };

  if (F["name[first]"]) trySet("name[first]", first);
  if (F["name[last]"])  trySet("name[last]",  last);

  if (F.email)            trySet(F.email,            v('email'));
  if (F.phone)            trySet(F.phone,            v('phone'));
  if (F.city)             trySet(F.city,             v('city'));
  if (F.service)          trySet(F.service,          selectedService?.n || "");
  if (F.citizenship)      trySet(F.citizenship,      v('citizenship'));
  if (F.resident_country) trySet(F.resident_country, v('residentCountry'));
  if (F.trackId && track) trySet(F.trackId,          track);

  return `${INTEGRATIONS.JOTFORM.FORM_URL}?${params.toString()}`;
}

/* ================= Google Sheets payload ================= */
function nowDetroitTimestamp() {
  const dt = new Date().toLocaleString('en-US', {
    timeZone: 'America/Detroit',
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', second: '2-digit',
    hour12: false
  });
  const [m,d,yAndTime] = dt.split('/');
  const [y, rest] = yAndTime.split(', ');
  return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')} ${rest}`;
}
function makeSubmissionId() {
  try { return crypto.randomUUID(); } catch(_) {
    return 'sub_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
  }
}
function buildPayload(track){
  const submission_id = makeSubmissionId();
  const payload = {
    timestamp: nowDetroitTimestamp(),
    track_id: track,
    service: selectedService?.n || '',
    country: country.value || '',
    fullName: v('fullName'),
    email: v('email'),
    phone: v('phone'),
    city: v('city'),
    citizenship: v('citizenship'),
    resident_country: v('residentCountry'),
    details: v('details'),
    files_count: (files && files.files ? files.files.length : 0),
    track_url: location.href,
    submission_id
  };
  buildPayload._last = payload;
  return payload;
}

/* ================= Integrations ================= */
async function fireIntegrations(payload){
  // EmailJS — optional
  try{
    if(window.emailjs && INTEGRATIONS.EMAILJS.PUBLIC_KEY){
      emailjs.init(INTEGRATIONS.EMAILJS.PUBLIC_KEY);
      const params = {
        ...payload,
        to_email: INTEGRATIONS.EMAILJS.TO_EMAIL,
        reply_to: payload.email,
        from_name: payload.fullName
      };
      await emailjs.send(INTEGRATIONS.EMAILJS.SERVICE_ID, INTEGRATIONS.EMAILJS.TEMPLATE_ID, params);
    }
  }catch(e){
    console.warn('[EmailJS] fail', e);
    showToast(LANG==='ar'?'تعذر إرسال البريد.':'Email could not be sent.');
  }

  // Google Sheets via Apps Script
  try{
    if(INTEGRATIONS.APPS_SCRIPT.ENDPOINT){
      const res = await fetch(INTEGRATIONS.APPS_SCRIPT.ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload),
        redirect: 'follow'
      });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok || !data?.ok){
        showToast(LANG==='ar'?'تعذر الحفظ في Google Sheets':'Failed to save to Google Sheets');
      } else if (data.submission_id) {
        buildPayload._last.submission_id = data.submission_id;
      }
    }
  }catch(e){
    console.warn('[GAS] fail', e);
    showToast(LANG==='ar'?'تعذر الحفظ في Google Sheets':'Failed to save to Google Sheets');
  }
}

/* ================= Files ================= */
files?.addEventListener('change', ()=>{
  fileList.innerHTML = '';
  let total = 0; let ok = true;
  [...(files.files||[])].forEach(f=>{
    const ext = (f.name.split('.').pop()||'').toLowerCase();
    total += f.size;
    if(!OK_EXT.includes(ext) || f.size>MAX_FILE) ok=false;
    const chip = document.createElement('div'); chip.className='file';
    chip.textContent = `${f.name} — ${(f.size/1024).toFixed(0)} KB`;
    fileList.appendChild(chip);
  });
  fileMeta.textContent = (files.files && files.files.length)
    ? ((LANG==='ar'?'عدد الملفات: ':'Files: ') + files.files.length + ' — ' + (LANG==='ar'?'الحجم الكلي ~ ':'Total ~ ') + (total/1024/1024).toFixed(2) + ' MB')
    : (LANG==='ar'?'لم يتم إرفاق ملفات بعد.':'No files attached.');
  if(!ok) showToast(LANG==='ar'?'تحذير: نوع/حجم ملف غير مسموح.':'Warning: invalid file type/size.');
});

/* ================= Smart Photo Capture (600×600, face-aware) ================= */
const avatarInput = $('avatarInput'),
      btnCamStart = $('btnCamStart'),
      btnCamShot  = $('btnCamShot'),
      btnAnalyze  = $('btnAnalyze'),
      cam         = $('cam'),
      photoCanvas = $('photoCanvas'),
      photoReport = $('photoReport');

let stream = null, avatarDataURL = "";
let faceDetector = null;

if ('FaceDetector' in window) {
  try { faceDetector = new window.FaceDetector({ fastMode: true, maxDetectedFaces: 1 }); } catch (_) { faceDetector = null; }
}

function setCanvasSize(canvas, w, h) {
  const dpr = window.devicePixelRatio || 1;
  canvas.width  = Math.round(w * dpr);
  canvas.height = Math.round(h * dpr);
  canvas.style.width  = `${w}px`;
  canvas.style.height = `${h}px`;
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  return ctx;
}
function avgLuminance(ctx, w, h, stride = 6) {
  const data = ctx.getImageData(0, 0, w, h).data;
  let lum = 0, count = 0;
  for (let y = 0; y < h; y += stride) {
    for (let x = 0; x < w; x += stride) {
      const i = (y * w + x) * 4;
      lum += 0.2126 * data[i] + 0.7152 * data[i+1] + 0.0722 * data[i+2];
      count++;
    }
  }
  return lum / count;
}
async function toSquare600Smart(source, mirrored = false) {
  const OUT = 600;
  const ctxOut = setCanvasSize(photoCanvas, OUT, OUT);

  const srcW = source.videoWidth || source.naturalWidth || source.width;
  const srcH = source.videoHeight || source.naturalHeight || source.height;

  let crop = null;

  if (faceDetector && srcW && srcH) {
    try {
      const tmp = document.createElement('canvas');
      tmp.width = srcW; tmp.height = srcH;
      const tctx = tmp.getContext('2d');

      if (mirrored) { tctx.translate(srcW, 0); tctx.scale(-1, 1); }
      tctx.drawImage(source, 0, 0, srcW, srcH);

      const bitmap = await createImageBitmap(tmp);
      const faces = await faceDetector.detect(bitmap);
      if (faces && faces.length) {
        const f = faces[0].boundingBox;
        const pad = Math.max(f.width, f.height) * 0.4;
        const cx = f.x + f.width / 2;
        const cy = f.y + f.height / 2;
        let side = Math.max(f.width, f.height) + pad * 2;

        let sx = Math.max(0, Math.round(cx - side / 2));
        let sy = Math.max(0, Math.round(cy - side / 2));
        if (sx + side > srcW) sx = Math.max(0, Math.round(srcW - side));
        if (sy + side > srcH) sy = Math.max(0, Math.round(srcH - side));

        side = Math.min(side, srcW, srcH);
        crop = { sx, sy, sw: Math.round(side), sh: Math.round(side) };

        const faceAreaPct = (f.width * f.height) / (srcW * srcH);
        if (faceAreaPct < 0.03) crop = null;
      }
    } catch (_) { crop = null; }
  }

  if (!crop) {
    const sw = Math.min(srcW, srcH);
    const sx = Math.round((srcW - sw) / 2);
    const sy = Math.round((srcH - sw) / 2);
    crop = { sx, sy, sw, sh: sw };
  }

  ctxOut.fillStyle = '#fff';
  ctxOut.fillRect(0, 0, OUT, OUT);
  ctxOut.drawImage(source, crop.sx, crop.sy, crop.sw, crop.sh, 0, 0, OUT, OUT);

  const luminance = avgLuminance(ctxOut, OUT, OUT);
  avatarDataURL = photoCanvas.toDataURL('image/jpeg', 0.92);
  $('avatar').src = avatarDataURL;
  photoCanvas.style.display = 'block';

  const brightOK = luminance > 95;
  photoReport.textContent =
    (brightOK
      ? (LANG==='ar' ? "✅ إضاءة جيدة – تحويل 600×600" : "✅ Good lighting – 600×600")
      : (LANG==='ar' ? "⚠️ الإضاءة منخفضة – تم التحويل 600×600" : "⚠️ Low lighting – 600×600")
    ) + (faceDetector ? (LANG==='ar' ? " | كشف وجه تلقائي" : " | Face auto-centered") : "");
  btnAnalyze.disabled = false;
}

avatarInput?.addEventListener('change', (e) => {
  const f = e.target.files?.[0];
  if (!f) return;
  const img = new Image();
  img.onload = () => toSquare600Smart(img, false);
  img.onerror = () => showToast(LANG==='ar'?'تعذر قراءة الصورة.':'Could not read image.');
  img.src = URL.createObjectURL(f);
});

async function startCamera() {
  try {
    btnCamStart.disabled = true;
    const constraints = {
      video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 1280 }, aspectRatio: { ideal: 1 }, frameRate: { ideal: 30 } },
      audio: false
    };
    if (!navigator.mediaDevices?.getUserMedia) throw new Error('MediaDevices not supported');
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    cam.srcObject = stream;

    await new Promise((res, rej) => {
      cam.onloadedmetadata = () => cam.play().then(res).catch(rej);
      setTimeout(() => (cam.videoWidth>0?res():rej(new Error('Video not ready'))), 1500);
    });

    cam.style.display = 'block';
    btnCamShot.disabled = false;
  } catch (err) {
    console.warn(err);
    alert(LANG==='ar'
      ? 'لا يمكن الوصول للكاميرا. تأكد من السماح وفتح الصفحة عبر HTTPS.'
      : 'Cannot access camera. Make sure permissions are granted and page is HTTPS.');
    btnCamStart.disabled = false;
  }
}
function stopCamera() {
  try { stream?.getTracks()?.forEach(t => t.stop()); } catch(_) {}
  cam.pause(); cam.srcObject = null; cam.style.display = 'none';
  btnCamShot.disabled = true; btnCamStart.disabled = false;
}
btnCamStart?.addEventListener('click', startCamera);

btnCamShot?.addEventListener('click', async () => {
  if (!stream || cam.videoWidth === 0) {
    alert(LANG==='ar'?'الفيديو غير جاهز.':'Video not ready.');
    return;
  }
  const vw = cam.videoWidth, vh = cam.videoHeight;
  const shot = document.createElement('canvas');
  shot.width = vw; shot.height = vh;
  const sctx = shot.getContext('2d');
  // Unmirror saved frame (preview mirrored via CSS)
  sctx.translate(vw, 0);
  sctx.scale(-1, 1);
  sctx.drawImage(cam, 0, 0, vw, vh);

  const img = new Image();
  img.onload = async () => { await toSquare600Smart(img, false); stopCamera(); };
  img.src = shot.toDataURL('image/jpeg', 0.92);
});

btnAnalyze?.addEventListener('click', () => {
  if (!avatarDataURL) {
    photoReport.textContent = (LANG==='ar' ? 'حمّل أو التقط صورة أولًا.' : 'Upload or capture a photo first.');
    return;
  }
  photoReport.textContent += (LANG==='ar' ? ' | فحص سريع ✅' : ' | Quick check ✅');
});

/* ================= UI helpers ================= */
function showToast(msg, ms=2400){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',ms); }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

/* ================= Init ================= */
applyLang();
setStep(0);
renderServices();
</script>
</body>
</html>
