<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù‡Ø¬Ø±Ø© Ø§Ù„Ø°ÙƒÙŠØ© â€“ Alhijrah Visa & Immigration Services</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Lite libs -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- EmailJS -->
  <script defer src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    :root{
      --gold:#ffd700; --gold2:#ffe483; --blue:#0b1e4d; --blue2:#04294a; --ink:#f5deb3; --line:#ffffff2a;
    }
    *{box-sizing:border-box}
    body{font-family:'Cairo',sans-serif;margin:0;background:linear-gradient(135deg,var(--blue),var(--blue2));color:var(--ink);padding-bottom:74px}
    a{color:inherit;text-decoration:none}
    .container{max-width:1100px;margin:auto;padding:28px}
    .card{background:rgba(3,23,58,.95);border:1px solid var(--line);border-radius:16px;box-shadow:0 0 20px #daa52055;padding:22px;animation:fadeIn .4s ease}
    h1{margin:0 0 6px;color:var(--gold);text-shadow:0 0 8px var(--gold)}
    h2{margin:0 0 12px;color:var(--gold2)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .row{display:grid;gap:12px}
    .col-2{grid-template-columns:1fr 1fr}
    .col-3{grid-template-columns:repeat(3,1fr)}
    @media(max-width:840px){.col-2,.col-3{grid-template-columns:1fr}}
    select,input,textarea{width:100%;background:#0b1e4d;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px;outline-color:var(--gold);transition:box-shadow .2s}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 12px #ffd700aa}
    label{display:block;margin:.35rem 0 .2rem;font-weight:700}
    button{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;transition:transform .08s}
    button:active{transform:translateY(1px)}
    .btn{background:var(--gold);color:#04294a}
    .btn.sec{background:#0b1e4d;color:#fff;border:1px solid var(--line)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .hint{color:#ffe59a;font-size:.95rem;margin:.25rem 0 .6rem}
    .muted{opacity:.85;font-size:.95rem}
    .progress{height:8px;background:#ffffff1a;border-radius:8px;overflow:hidden;margin:10px 0 16px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--gold),var(--gold2));transition:width .25s}
    .services{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:12px;background:#041c3f}
    .svc{background:#0c2a6b;border:1px solid var(--line);border-radius:10px;padding:10px 12px;margin:6px 0;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .svc:hover{background:var(--gold);color:#04294a;box-shadow:0 0 12px #ffd700}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:#0b1e4d;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0}
    .files{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .file{border:1px solid var(--line);border-radius:10px;padding:6px 10px;background:#0b1e4d}
    .toast{position:fixed;top:14px;left:50%;transform:translateX(-50%);background:#05224a;color:#ffd700;border:1px solid #ffd70066;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:1300;display:none}
    .loading{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1250;display:none}
    .loading .box{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#041c3f;border:1px solid var(--line);border-radius:14px;padding:16px 18px;box-shadow:0 10px 28px rgba(0,0,0,.45)}
    .spinner{width:22px;height:22px;border:3px solid #fff3;border-top-color:var(--gold);border-radius:50%;display:inline-block;animation:spin 1s linear infinite;margin-inline-end:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Social left */
    .social-left{position:fixed;left:12px;top:50%;transform:translateY(-50%);z-index:1000}
    .social-left .stack{display:flex;flex-direction:column;gap:10px}
    .social-left a{width:44px;height:44px;display:grid;place-items:center;border-radius:12px;background:rgba(255,255,255,.12);border:1px solid var(--line);color:#fff;transition:transform .15s, box-shadow .25s}
    .social-left a:hover{transform:translateY(-2px);box-shadow:0 10px 26px rgba(0,0,0,.35)}

    /* Footer (VIP) */
    footer{margin-top:40px}
    .footer-vip{position:relative;overflow:hidden;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.16);box-shadow:0 20px 50px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.08);backdrop-filter:blur(12px)}
    .footer-vip .glow{position:absolute;inset:-2px;border-radius:20px;background:conic-gradient(from 180deg,rgba(255,215,0,.35),rgba(57,255,20,.15),transparent 40%,rgba(0,230,230,.18));filter:blur(24px);opacity:.6;pointer-events:none}
    .footer-inner{max-width:1100px;margin:auto;padding:24px}
    .footer-grid{display:grid;gap:16px;grid-template-columns:2fr 1.3fr 1.3fr 1.6fr}
    @media(max-width:980px){.footer-grid{grid-template-columns:1fr 1fr}} @media(max-width:640px){.footer-grid{grid-template-columns:1fr}}
    .footer-title{color:#ffe483;font-weight:900;letter-spacing:.4px;margin-bottom:8px;text-shadow:0 0 12px rgba(255,215,0,.35)}
    .footer-box{background:rgba(11,30,77,.55);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;box-shadow:inset 0 0 18px rgba(255,255,255,.04)}
    .footer-links a{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);margin:7px 0}
    .footer-cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .badge-vip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,215,0,.5);background:linear-gradient(180deg,rgba(255,215,0,.18),rgba(255,255,255,.02));color:#ffd700;font-weight:800;font-size:.95rem}
    .copy{margin-top:8px;opacity:.9}

    /* Ticker */
    .ticker{position:fixed;left:0;right:0;bottom:0;z-index:1200;padding:8px 0;backdrop-filter:blur(10px)}
    .ticker .wrap{max-width:1240px;margin:auto;padding:0 14px;border:1px solid rgba(255,255,255,.16);border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));box-shadow:0 -12px 30px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.08);position:relative;overflow:hidden}
    .ticker .wrap::before{content:"";position:absolute;inset:-2px;border-radius:16px;background:conic-gradient(from 90deg,rgba(255,215,0,.35),rgba(0,230,230,.18),transparent 40%);filter:blur(18px);opacity:.45;pointer-events:none}
    .ticker-row{display:flex;gap:10px;align-items:center;padding:10px 8px}
    .ticker-icon{color:#ffd700;font-size:1.1rem}
    .marquee{overflow:hidden;white-space:nowrap;flex:1}
    .marquee-line{display:inline-block;padding-left:40px;animation:marquee 40s linear infinite}
    .marquee:hover .marquee-line{animation-play-state:paused}
    @keyframes marquee{from{transform:translateX(0)}to{transform:translateX(-50%)}}
    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;margin:0 8px;border-radius:999px;border:1px dashed rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
    .tag i{color:#ffe483}

    /* Client Card */
    #clientCard{position:relative;border-radius:22px;overflow:hidden;margin-top:20px;background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.16);box-shadow:0 16px 44px rgba(0,0,0,.45);display:none}
    #clientCard .neon{content:"";position:absolute;inset:-2px;border-radius:24px;z-index:0;background:conic-gradient(from 180deg,rgba(255,215,0,.55),rgba(0,230,230,.35),transparent 40%,rgba(57,255,20,.35));filter:blur(22px);opacity:.7;pointer-events:none}
    #clientCard .inner{position:relative;z-index:1}
    .card-head{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .avatar.vip{width:110px;height:110px;border-radius:50%;object-fit:cover;border:3px solid #ffd700;box-shadow:0 0 20px rgba(255,215,0,.35),inset 0 0 18px rgba(255,255,255,.25);background:#fff}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);color:#ffe483;border-radius:999px;padding:6px 10px;font-weight:800}
    .kv{display:grid;gap:8px;grid-template-columns:repeat(2,1fr)}
    @media(max-width:700px){.kv{grid-template-columns:1fr}}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

    /* Photo capture */
    .photo-box{background:rgba(255,255,255,.05);border:1px dashed rgba(255,255,255,.25);border-radius:14px;padding:10px}
    #cam{width:100%;border-radius:12px;display:none; transform: scaleX(-1);} /* mirror ONLY preview */
    #photoCanvas{width:100%;max-height:320px;border-radius:12px;display:none;background:#fff}
    .photo-hint{font-size:.95rem;color:#ffe59a}

    /* Hide Jotform controls in UI (kept in code for future use) */
    #btnJotPrefill, #btnJotTable, #btnJotBoard, #jotHint { display:none !important; }
  </style>
</head>
<body>

<!-- Social icons left -->
<div class="social-left" aria-label="Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„">
  <div class="stack card" style="padding:8px">
    <a href="https://wa.me/13139194272" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
    <a href="mailto:visa@alhijrahservices.com" title="Email"><i class="fa-solid fa-envelope"></i></a>
    <a href="https://alhijrahvisa.com" target="_blank" title="Website"><i class="fa-solid fa-globe"></i></a>
    <a href="https://www.facebook.com/share/19gTVpmjVo/" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
    <a href="https://www.instagram.com/alhijrahservices/" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="toolbar" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <h1 id="title">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù‡Ø¬Ø±Ø© Ø§Ù„Ø°ÙƒÙŠØ© â€“ Alhijrah Visa & Immigration Services</h1>
      <div>
        <label for="lang" class="muted" style="display:inline-block;margin-inline-end:6px">Ø§Ù„Ù„ØºØ© / Language</label>
        <select id="lang" style="width:auto">
          <option value="ar" selected>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>
    <p id="tagline" class="muted" style="margin-top:0">
      Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù€ <b>Alhijrah Visa & Immigration Services</b> â€” ØªØ¬Ø±Ø¨Ø© Ù‡Ø¬Ø±Ø© Ù…ØªÙƒØ§Ù…Ù„Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©.
    </p>

    <div class="progress"><div id="bar" class="bar"></div></div>

    <!-- Step 1 -->
    <section id="step1">
      <div class="row col-3">
        <div class="colspan">
          <label id="labelCountry" for="country">Ø§Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„ØªØµÙ†ÙŠÙ</label>
          <select id="country" required>
            <option value="" selected disabled>â€” Ø§Ø®ØªØ± â€”</option>
            <option value="usa">Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©</option>
            <option value="canada">ÙƒÙ†Ø¯Ø§</option>
            <option value="australia">Ø£Ø³ØªØ±Ø§Ù„ÙŠØ§</option>
            <option value="newzealand">Ù†ÙŠÙˆØ²ÙŠÙ„Ù†Ø¯Ø§</option>
            <option value="yemen">Ø§Ù„ÙŠÙ…Ù†</option>
            <option value="translation">Ø§Ù„ØªØ±Ø¬Ù…Ø©</option>
            <option value="notarization">Ø§Ù„ØªÙˆØ«ÙŠÙ‚</option>
            <option value="powerofattorney">Ø§Ù„ØªÙˆÙƒÙŠÙ„ ÙˆØ§Ù„ØªØ¹Ù…ÙŠØ¯</option>
            <option value="hajj">Ø§Ù„Ø­Ø¬ ÙˆØ§Ù„Ø¹Ù…Ø±Ø©</option>
            <option value="flights">Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø·ÙŠØ±Ø§Ù†</option>
          </select>
          <div id="hintCountry" class="hint">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ Ø«Ù… Ø§Ø¨Ø­Ø« Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØªØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.</div>
        </div>
        <div class="colspan">
          <label id="labelSearch" for="svcSearch">Ø¨Ø­Ø« Ø¹Ù† Ø®Ø¯Ù…Ø©</label>
          <input id="svcSearch" placeholder="Ø§ÙƒØªØ¨ Ù…Ø«Ù„Ù‹Ø§: ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø±ÙŠÙ† ÙƒØ§Ø±Ø¯ØŒ Ø§Ù„ØªØ£Ø´ÙŠØ±Ø© Ø§Ù„Ø³ÙŠØ§Ø­ÙŠØ©â€¦" />
        </div>
        <div class="toolbar" style="align-self:end">
          <button id="next1" class="btn">Ø§Ù„ØªØ§Ù„ÙŠ â†’</button>
        </div>
      </div>

      <div class="services" id="svcBox" aria-live="polite" aria-atomic="true" style="margin-top:10px">
        <div id="svcMuted" class="muted">Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø¨Ø­Ø«â€¦</div>
        <div id="svcList"></div>
      </div>
    </section>

    <!-- Step 2 -->
    <section id="step2" style="display:none">
      <h2 id="formTitle">Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨</h2>
      <div class="pill"><b id="labelServiceBold">Ø§Ù„Ø®Ø¯Ù…Ø©:</b>&nbsp;<span id="svcNamePill">â€”</span></div>
      <div id="reqDocs" class="hint"></div>

      <div class="row col-2" style="margin-top:8px">
        <div>
          <label id="labelFullName" for="fullName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
          <input id="fullName" required placeholder="Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ø²" />
        </div>
        <div>
          <label id="labelEmail" for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *</label>
          <input id="email" type="email" required placeholder="example@mail.com" />
        </div>
        <div>
          <label id="labelPhone" for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
          <input id="phone" required placeholder="+1313XXXXXXXX Ø£Ùˆ 00966XXXXXXX" />
          <div id="hintPhone" class="hint">ÙŠÙØ³Ù…Ø­ Ø¨ØµÙŠØºØ© + Ø£Ùˆ 00ØŒ 8â€“15 Ø±Ù‚Ù….</div>
        </div>
        <div>
          <label id="labelCity" for="city">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="city" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ø¯ÙŠØ±Ø¨ÙˆØ±Ù†â€¦" />
        </div>
        <div>
          <label id="labelCitizenship" for="citizenship">Ø§Ù„Ø¬Ù†Ø³ÙŠØ© *</label>
          <input id="citizenship" required placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„ÙŠÙ…Ù†ÙŠØ© / Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© / Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠØ©â€¦" />
        </div>
        <div>
          <label id="labelResident" for="residentCountry">Ø¨Ù„Ø¯ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© *</label>
          <input id="residentCountry" required placeholder="Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙŠ ØªÙ‚ÙŠÙ… ÙÙŠÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹" />
        </div>
      </div>

      <label id="labelDetails" for="details">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <textarea id="details" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ³Ø§Ø¹Ø¯Ù†Ø§ (ØªÙˆØ§Ø±ÙŠØ®ØŒ Ø£Ø±Ù‚Ø§Ù… Ø¥ÙŠØµØ§Ù„Ø§ØªØŒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª)â€¦"></textarea>

      <label id="labelFiles" for="files">Ø¥Ø±ÙØ§Ù‚ Ù…Ø³ØªÙ†Ø¯Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="files" type="file" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" />
      <div class="muted" id="fileMeta">Ù„Ù… ÙŠØªÙ… Ø¥Ø±ÙØ§Ù‚ Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯.</div>
      <div class="files" id="fileList"></div>

      <!-- Smart Photo Capture -->
      <div class="photo-box" style="margin-top:10px">
        <label id="labelPhoto">ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© 600Ã—600 (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
        <div class="toolbar" style="margin:6px 0 8px">
          <input id="avatarInput" type="file" accept="image/*" />
          <button id="btnCamStart" class="btn sec" type="button"><i class="fa-solid fa-camera"></i> <span id="bCam">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</span></button>
          <button id="btnCamShot" class="btn sec" type="button" disabled><i class="fa-solid fa-bullseye"></i> <span id="bShot">Ø§Ù„ØªÙ‚Ø§Ø·</span></button>
          <button id="btnAnalyze" class="btn" type="button" disabled><i class="fa-solid fa-wand-magic-sparkles"></i> <span id="bAnalyze">ÙØ­Øµ/ØªØ­Ø³ÙŠÙ†</span></button>
        </div>
        <video id="cam" autoplay playsinline></video>
        <canvas id="photoCanvas"></canvas>
        <div id="photoReport" class="photo-hint"></div>
        <div id="photoHint" class="photo-hint">* Ø¥Ø°Ø§ Ù„Ù… ÙŠØ³Ù…Ø­ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (ÙŠØªØ·Ù„Ø¨ HTTPS)ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±ÙØ¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ.</div>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <button id="prev2" class="btn sec">Ø±Ø¬ÙˆØ¹</button>
        <button id="next2" class="btn">Ù…Ø±Ø§Ø¬Ø¹Ø© â†’</button>
      </div>
    </section>

    <!-- Step 3 -->
    <section id="step3" style="display:none">
      <h2 id="reviewTitle">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨</h2>
      <div id="reviewBox" class="card" style="background:#041c3f"></div>
      <div class="toolbar" style="margin-top:10px">
        <button id="prev3" class="btn sec">ØªØ¹Ø¯ÙŠÙ„</button>
        <button id="submit" class="btn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
      </div>

      <!-- Jotform controls (hidden via CSS) -->
      <div class="toolbar" id="jotControls" style="margin-top:10px; justify-content:flex-start">
        <a id="btnJotPrefill" class="btn sec" target="_blank" rel="noopener"><i class="fa-solid fa-up-right-from-square"></i> <span id="bJotOpen">ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Jotform (Ù…Ø¹Ø¨Ø£)</span></a>
        <a id="btnJotTable" class="btn sec" target="_blank" rel="noopener"><i class="fa-solid fa-table"></i> Jotform Table</a>
        <a id="btnJotBoard" class="btn sec" target="_blank" rel="noopener"><i class="fa-solid fa-grip"></i> Jotform Board</a>
      </div>
      <div id="jotHint" class="hint">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…ÙØ±ÙƒÙ‘Ø¨ (Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„/Ø§Ù„Ø£Ø®ÙŠØ±) Ù…ÙÙØ¹Ù‘Ù„ Ù„Ù„Ù€ Jotform Prefill.</div>
    </section>

    <!-- Client Card -->
    <section id="clientCard" class="card">
      <div class="neon"></div>
      <div class="inner">
        <h2 id="cardTitle" style="margin-top:0">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© (VIP)</h2>
        <div class="card-head">
          <img class="avatar vip" id="avatar" src="https://via.placeholder.com/110x110.png?text=AL" alt="Applicant Photo"/>
          <div class="chips">
            <span class="chip"><i class="fa-solid fa-hashtag"></i> <span id="cTrack">TrackID:</span> <span id="trackId">â€”</span></span>
            <span class="chip"><i class="fa-solid fa-star"></i> <span id="cService">Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span id="svcOut">â€”</span></span>
            <span class="chip"><i class="fa-solid fa-shield-halved"></i> <span id="cSecure">Ù…Ø­Ù…ÙŠ</span></span>
          </div>
          <div id="qrcode" style="margin-inline-start:auto"></div>
        </div>

        <div class="kv" id="cardData" style="margin-top:10px"></div>

        <div class="actions">
          <button id="dlPDF" class="btn"><i class="fa-solid fa-file-arrow-down"></i> <span id="bPDF">ØªÙ†Ø²ÙŠÙ„ PDF</span></button>
          <button id="dlWord" class="btn sec"><i class="fa-solid fa-file-word"></i> <span id="bWord">ØªÙ†Ø²ÙŠÙ„ Word</span></button>
          <a id="waShare" class="btn sec" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> <span id="bWA">Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</span></a>
          <button id="printCard" class="btn sec"><i class="fa-solid fa-print"></i> <span id="bPrint">Ø·Ø¨Ø§Ø¹Ø©</span></button>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- Footer -->
<footer>
  <div class="footer-vip">
    <div class="glow"></div>
    <div class="footer-inner">
      <div class="footer-grid">
        <div class="footer-box">
          <div class="footer-title" id="fBrand">Alhijrah Visa & Immigration Services</div>
          <div class="muted" id="fTag">ÙˆØ§Ø¬Ù‡Ø© Ø²Ø¬Ø§Ø¬ÙŠØ© Ø°ÙƒÙŠØ© â€” ØªØ¬Ø±Ø¨Ø© VIP Ù…ÙˆØ«ÙˆÙ‚Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©.</div>
          <div class="footer-cta">
            <span class="badge-vip"><i class="fa-solid fa-crown"></i> VIP</span>
            <span class="badge-vip"><i class="fa-solid fa-shield-halved"></i> Secure</span>
            <span class="badge-vip"><i class="fa-solid fa-bolt"></i> Smart Portal</span>
          </div>
        </div>

        <div class="footer-box footer-links">
          <div class="footer-title" id="fContact">ØªÙˆØ§ØµÙ„</div>
          <a href="https://wa.me/13139194272" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp: +1 (313) 919-4272</a>
          <a href="mailto:visa@alhijrahservices.com"><i class="fa-solid fa-envelope"></i> visa@alhijrahservices.com</a>
          <a href="tel:+13139194272"><i class="fa-solid fa-phone"></i> +1 (313) 919-4272</a>
        </div>

        <div class="footer-box footer-links">
          <div class="footer-title" id="fLinks">Ø±ÙˆØ§Ø¨Ø·</div>
          <a href="https://alhijrahvisa.com" target="_blank"><i class="fa-solid fa-globe"></i> Official Site</a>
          <a href="https://www.facebook.com/share/19gTVpmjVo/" target="_blank"><i class="fab fa-facebook-f"></i> Facebook</a>
          <a href="https://www.instagram.com/alhijrahservices/" target="_blank"><i class="fab fa-instagram"></i> Instagram</a>
        </div>

        <div class="footer-box">
          <div class="footer-title" id="fBooking">Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ø³ØªØ´Ø§Ø±Ø§Øª</div>
          <div class="muted" id="fHours">Ø§Ø³ØªØ´Ø§Ø±Ø§Øª ÙŠÙˆÙ…ÙŠÙ‹Ø§ 10 Øµ â€“ 6 Ù… (EST)</div>
          <div class="footer-cta" style="margin-top:6px">
            <a class="btn" href="https://calendly.com/alhijrahservices-info/professional-consultation-alhijrah-immigration?month=2025-08" target="_blank" rel="noopener"><i class="fa-solid fa-calendar-days"></i> <span id="fBook">Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†</span></a>
            <a class="btn sec" href="mailto:visa@alhijrahservices.com"><i class="fa-solid fa-envelope"></i> <span id="fEmailUs">Ø±Ø§Ø³Ù„Ù†Ø§</span></a>
          </div>
        </div>
      </div>
      <div class="copy">Â© <span id="yr"></span> Alhijrah Services â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</div>
    </div>
  </div>
</footer>

<!-- Toast + Loading -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="loading" class="loading"><div class="box"><span class="spinner"></span><span id="loadingText">Ø¬Ø§Ø±Ù ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§ØªÙƒâ€¦</span></div></div>

<!-- Thank You Overlay -->
<div id="thanksWrap" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1200">
  <div id="thanksCard" class="card" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);max-width:560px;width:90%;text-align:center;animation:pop .35s ease">
    <h2 id="thanksTitle">ğŸ‰ Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ!</h2>
    <p id="thanksDesc" style="margin:.5rem 0 1rem">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†Ø±Ø§Ø¬Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆÙ†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ù‹Ø§.</p>
    <div class="toolbar" style="justify-content:center">
      <button id="btnViewCard" class="btn">Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
      <button id="btnCloseThanks" class="btn sec">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- VIP Glass Ticker -->
<div class="ticker" aria-label="Ø´Ø±ÙŠØ· Ø®Ø¯Ù…Ø§Øª ÙˆØªÙˆØ§ØµÙ„">
  <div class="wrap">
    <div class="ticker-row">
      <i class="fa-solid fa-bullhorn ticker-icon"></i>
      <div class="marquee">
        <div class="marquee-line" id="tickerLine">
          <!-- Filled by JS for current language -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const INTEGRATIONS = {
  EMAILJS: {
    PUBLIC_KEY: "0Cub6o0xkk9eYTe90",
    SERVICE_ID: "service_flhs3e5",
    TEMPLATE_ID: "template_mguzw2l",
    TO_EMAIL: "Jobs@alhijrahservices.com"
  },
  APPS_SCRIPT: {
    ENDPOINT: "https://script.google.com/macros/s/AKfycbzN07vwQbkeixwM4WGnfiODt6uzUQMFCJ-AyxtFZ2oGX0603YqiMw1xUlq-v5UG4xtf/exec"
  },
  JOTFORM: {
    FORM_URL: "https://form.jotform.com/AlhijrahServices/Alhijrahsmartportal",
    BOARD_URL: "https://www.jotform.com/boards/252149440362049",
    TABLE_URL: "https://www.jotform.com/tables/250817936172058",
    FIELD_MAP: {
      "name[first]": "first_name",
      "name[last]": "last_name",
      "email": "email",
      "phone": "phone",
      "city": "city",
      "service": "service",
      "citizenship": "citizenship",
      "resident_country": "resident_country",
      "trackId": "track_id"
    },
    AUTO_OPEN_ON_SUBMIT: false // keep users on-site
  }
};

const TEXT = {
  ar: {
    ui: {
      title: "Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù‡Ø¬Ø±Ø© Ø§Ù„Ø°ÙƒÙŠØ© â€“ Alhijrah Visa & Immigration Services",
      tagline: "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø±Ø³Ù…ÙŠØ© â€” ØªØ¬Ø±Ø¨Ø© Ù‡Ø¬Ø±Ø© Ù…ØªÙƒØ§Ù…Ù„Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©.",
      countryLabel: "Ø§Ù„Ø¯ÙˆÙ„Ø©/Ø§Ù„ØªØµÙ†ÙŠÙ",
      countryHint: "Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ Ø«Ù… Ø§Ø¨Ø­Ø« Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØªØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.",
      searchLabel: "Ø¨Ø­Ø« Ø¹Ù† Ø®Ø¯Ù…Ø©",
      next: "Ø§Ù„ØªØ§Ù„ÙŠ â†’",
      formTitle: "Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨",
      serviceBold: "Ø§Ù„Ø®Ø¯Ù…Ø©:",
      fullName: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *",
      email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *",
      phone: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *",
      city: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
      citizenship: "Ø§Ù„Ø¬Ù†Ø³ÙŠØ© *",
      resident: "Ø¨Ù„Ø¯ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© *",
      details: "ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
      attach: "Ø¥Ø±ÙØ§Ù‚ Ù…Ø³ØªÙ†Ø¯Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
      phoneHint: "ÙŠÙØ³Ù…Ø­ Ø¨ØµÙŠØºØ© + Ø£Ùˆ 00ØŒ 8â€“15 Ø±Ù‚Ù….",
      photoLabel: "ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© 600Ã—600 (ØªÙ„Ù‚Ø§Ø¦ÙŠ)",
      bCam: "ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§", bShot: "Ø§Ù„ØªÙ‚Ø§Ø·", bAnalyze:"ÙØ­Øµ/ØªØ­Ø³ÙŠÙ†",
      photoHint: "* Ø¥Ø°Ø§ Ù„Ù… ÙŠØ³Ù…Ø­ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (ÙŠØªØ·Ù„Ø¨ HTTPS)ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±ÙØ¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ.",
      back: "Ø±Ø¬ÙˆØ¹", reviewGo: "Ù…Ø±Ø§Ø¬Ø¹Ø© â†’",
      reviewTitle: "Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨",
      edit: "ØªØ¹Ø¯ÙŠÙ„", submit: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„",
      jotOpen: "ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Jotform (Ù…Ø¹Ø¨Ø£)",
      jotHint: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…ÙØ±ÙƒÙ‘Ø¨ (Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„/Ø§Ù„Ø£Ø®ÙŠØ±) Ù…ÙÙØ¹Ù‘Ù„ Ù„Ù„Ù€ Jotform Prefill.",
      cardTitle: "Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© (VIP)",
      cTrack: "TrackID:", cService:"Ø§Ù„Ø®Ø¯Ù…Ø©:", cSecure:"Ù…Ø­Ù…ÙŠ",
      bPDF:"ØªÙ†Ø²ÙŠÙ„ PDF", bWA:"Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨", bPrint:"Ø·Ø¨Ø§Ø¹Ø©",
      thanksTitle:"ğŸ‰ Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ!", thanksDesc:"ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†Ø±Ø§Ø¬Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆÙ†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ù‹Ø§.",
      load:"Ø¬Ø§Ø±Ù ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§ØªÙƒâ€¦",
      fBrand:"Alhijrah Visa & Immigration Services",
      fTag:"ÙˆØ§Ø¬Ù‡Ø© Ø²Ø¬Ø§Ø¬ÙŠØ© Ø°ÙƒÙŠØ© â€” ØªØ¬Ø±Ø¨Ø© VIP Ù…ÙˆØ«ÙˆÙ‚Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©.",
      fContact:"ØªÙˆØ§ØµÙ„", fLinks:"Ø±ÙˆØ§Ø¨Ø·", fBooking:"Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ø³ØªØ´Ø§Ø±Ø§Øª", fHours:"Ø§Ø³ØªØ´Ø§Ø±Ø§Øª ÙŠÙˆÙ…ÙŠÙ‹Ø§ 10 Øµ â€“ 6 Ù… (EST)", fBook:"Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†", fEmailUs:"Ø±Ø§Ø³Ù„Ù†Ø§",
      svcEmpty:"Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø¨Ø­Ø«â€¦",
      svcNoMatch:"Ù„Ø§ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.",
      chooseFirst:"Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ Ø£ÙˆÙ„Ø§Ù‹.", chooseService:"Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.",
      checkRequired:"ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø¬Ù†Ø³ÙŠØ© ÙˆØ¨Ù„Ø¯ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©.",
      toastChosen:"ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø¯Ù…Ø©: ",
      ticker: [
        "Ø®Ø¯Ù…Ø§Øª USCIS Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ© ÙˆØ§Ù„ÙˆØ¸ÙŠÙÙŠØ©",
        "Ø¬ÙˆØ§Ø²Ø§Øª Ø§Ù„Ø³ÙØ± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠØ© ÙˆØ§Ù„ÙŠÙ…Ù†ÙŠØ©",
        "Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ ÙˆØ§Ù„ØªØ¬Ø¯ÙŠØ¯",
        "Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø³ÙØ§Ø±Ø§Øª ÙˆØªØ£Ø´ÙŠØ±Ø§Øª",
        "ØªØ±Ø¬Ù…Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØªÙˆØ«ÙŠÙ‚ ÙˆÙˆÙƒØ§Ù„Ø§Øª",
        "Ø­Ø¬ÙˆØ²Ø§Øª Ø·ÙŠØ±Ø§Ù† ÙˆØªØ£Ù…ÙŠÙ† Ø³ÙØ±",
        "Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© â€” VIP"
      ]
    },
    services: {
      usa: [
        {ar:"Ù„Ù…Ù‘ Ø´Ù…Ù„ Ø§Ù„Ø£Ø³Ø±Ø©", en:"Family Sponsorship"},
        {ar:"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Ø£Ù…Ø±ÙŠÙƒØ§", en:"Adjustment of Status"},
        {ar:"ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„", en:"Work Authorization"},
        {ar:"ØªØµØ±ÙŠØ­ Ø³ÙØ±/Ø¥Ø¹Ø§Ø¯Ø© Ø¯Ø®ÙˆÙ„", en:"Advance Parole / Reentry"},
        {ar:"ØªØ¹Ù‡Ø¯ Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¯Ø¹Ù…", en:"Affidavit of Support"},
        {ar:"ØªØºÙŠÙŠØ±/ØªÙ…Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø²Ø§Ø¦Ø±", en:"Change/Extend Status"},
        {ar:"ØªØ£Ø´ÙŠØ±Ø© Ø®Ø·ÙˆØ¨Ø©/Ø²ÙˆØ§Ø¬", en:"FiancÃ©(e)/Marriage (K-1/K-3)"},
        {ar:"Ø¥Ø²Ø§Ù„Ø© Ø´Ø±Ø· Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©", en:"Remove Conditions"},
        {ar:"ØªØ¬Ø¯ÙŠØ¯/Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¬Ø±ÙŠÙ† ÙƒØ§Ø±Ø¯", en:"Green Card Renewal/Replacement"},
        {ar:"Ø§Ù„ØªØ¬Ù†Ø³ Ø¨Ø§Ù„Ø¬Ù†Ø³ÙŠØ©", en:"Naturalization"},
        {ar:"Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¬Ù†Ø³ÙŠØ©", en:"Certificate of Citizenship"},
        {ar:"Ø¥Ø¹ÙØ§Ø¡Ø§Øª ÙˆÙ…Ø®Ø§Ù„ÙØ§Øª", en:"Waivers"},
        {ar:"ØªØµØ§Ø±ÙŠØ­ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…", en:"Permission to Reapply"},
        {ar:"Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¤Ù‚ØªØ©", en:"Temporary Protected Status"},
        {ar:"Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¯ÙƒØ§ (Ø­ÙŠØ« ÙŠÙ†Ø·Ø¨Ù‚)", en:"DACA"},
        {ar:"Ø·Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„ (FOIA)", en:"FOIA Records"},
        {ar:"Ø§Ù„Ù„Ø¬ÙˆØ¡ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©", en:"Asylum Support"},
        {ar:"Ø¥ØµØ¯Ø§Ø±/ØªØ¬Ø¯ÙŠØ¯ Ø¬ÙˆØ§Ø² Ø£Ù…Ø±ÙŠÙƒÙŠ", en:"U.S. Passport â€“ New/Renewal"},
        {ar:"ØªÙ‚Ø±ÙŠØ± ÙˆÙ„Ø§Ø¯Ø© Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬", en:"Consular Report of Birth Abroad"},
        {ar:"Ø®Ø¯Ù…Ø§Øª Ù‚Ù†ØµÙ„ÙŠØ©/ØªÙˆØ«ÙŠÙ‚", en:"Consular/Notarial Appointments"},
        {ar:"ØªØ£Ø´ÙŠØ±Ø© Ø²ÙŠØ§Ø±Ø©/Ø³ÙŠØ§Ø­Ø©/Ø£Ø¹Ù…Ø§Ù„", en:"Visitor/Tourist/Business Visa"},
        {ar:"ØªØ£Ø´ÙŠØ±Ø© Ø¯Ø±Ø§Ø³Ø©", en:"Student Visa"},
        {ar:"ØªØ£Ø´ÙŠØ±Ø§Øª ØªØ¨Ø§Ø¯Ù„/Ø¹Ù…Ù„ Ù…ØªØ®ØµØµ/Ø´Ø±ÙƒØ©", en:"Exchange/Skilled/Intracompany"},
        {ar:"ØªØ£Ø´ÙŠØ±Ø§Øª ÙƒÙØ§Ø¡Ø§Øª/Ù…Ø³ØªØ«Ù…Ø±", en:"Extraordinary Ability/Investor"},
        {ar:"ØªØ£Ø´ÙŠØ±Ø§Øª Ø¹Ø¨ÙˆØ±/Ø·Ø§Ù‚Ù…/Ø¯ÙŠÙ†ÙŠØ©", en:"Transit/Crew/Religious"},
        {ar:"Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚Ù†ØµÙ„ÙŠØ© Ù„Ù„Ù‡Ø¬Ø±Ø©", en:"Immigrant Consular Processing"},
        {ar:"Ù…ØªØ§Ø¨Ø¹Ø© Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©", en:"Follow-to-Join / Action on Approval"},
        {ar:"ØªØºÙŠÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª", en:"Address Change"},
        {ar:"Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª ÙˆØªØµØ­ÙŠØ­ Ø¨ÙŠØ§Ù†Ø§Øª", en:"Records Correction & Inquiries"}
      ],
      canada: [
        {ar:"Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ â€“ Ø¹Ù…Ø§Ù„ Ù…Ù‡Ø±Ø©", en:"Express Entry"},
        {ar:"Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ±Ø´ÙŠØ­ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ", en:"Provincial Nominee Program"},
        {ar:"ØªØµØ±ÙŠØ­ Ø¯Ø±Ø§Ø³Ø©", en:"Study Permit"},
        {ar:"ØªØµØ±ÙŠØ­ Ø¹Ù…Ù„", en:"Work Permit"},
        {ar:"Ø±Ø¹Ø§ÙŠØ© Ø¹Ø§Ø¦Ù„ÙŠØ©", en:"Family Sponsorship"},
        {ar:"ØªØ£Ø´ÙŠØ±Ø© Ø²Ø§Ø¦Ø± / eTA", en:"Visitor Visa / eTA"},
        {ar:"ØªØ¬Ø¯ÙŠØ¯ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©", en:"PR Card Renewal"}
      ],
      australia: [
        {ar:"Ù‡Ø¬Ø±Ø© Ù…Ù‡Ø§Ø±ÙŠØ©", en:"Skilled Migration"},
        {ar:"ØªØ£Ø´ÙŠØ±Ø© Ø·Ø§Ù„Ø¨", en:"Student Visa"},
        {ar:"Ø²Ø§Ø¦Ø±/Ø³ÙŠØ§Ø­Ø©", en:"Visitor Visa"},
        {ar:"Ø£Ø³Ø±Ø©/Ø´Ø±ÙŠÙƒ", en:"Partner/Parent"},
        {ar:"Ø¹Ù…Ù„ Ù…Ø¤Ù‚Øª", en:"Temporary Work"}
      ],
      newzealand: [
        {ar:"Ø¹Ù…Ù„/Ù…Ù‡Ø§Ø±Ø§Øª", en:"Skilled/Work"},
        {ar:"Ø·Ø§Ù„Ø¨", en:"Student"},
        {ar:"Ø²Ø§Ø¦Ø±", en:"Visitor"},
        {ar:"Ø£Ø³Ø±Ø©/Ø´Ø±ÙŠÙƒ", en:"Family/Partner"}
      ],
      yemen: [
        {ar:"Ø¥ØµØ¯Ø§Ø± Ø¬ÙˆØ§Ø²", en:"New Passport"},
        {ar:"ØªØ¬Ø¯ÙŠØ¯ Ø¬ÙˆØ§Ø²", en:"Passport Renewal"},
        {ar:"Ø§Ù„Ø¥Ù‚Ø§Ù…Ø§Øª", en:"Residency Services"},
        {ar:"Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¯Ù†ÙŠØ©", en:"Civil Records"}
      ],
      translation: [
        {ar:"ØªØ±Ø¬Ù…Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ù…Ø¹ØªÙ…Ø¯Ø©", en:"Certified Legal Translation"},
        {ar:"ØªØ±Ø¬Ù…Ø© Ø´Ù‡Ø§Ø¯Ø§Øª/Ø¹Ù‚ÙˆØ¯", en:"Certificates/Contracts"},
        {ar:"Ø®ØªÙ… ÙˆØªÙˆØ«ÙŠÙ‚ ØªØ±Ø¬Ù…Ø©", en:"Stamped & Notarized"}
      ],
      notarization: [
        {ar:"ØªÙˆØ«ÙŠÙ‚ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯", en:"Contract Notarization"},
        {ar:"Ø§Ù„ØªØµØ¯ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª", en:"Signature Attestation"}
      ],
      powerofattorney: [
        {ar:"ÙˆÙƒØ§Ù„Ø© Ø¹Ø§Ù…Ø©", en:"General Power of Attorney"},
        {ar:"ÙˆÙƒØ§Ù„Ø© Ø®Ø§ØµØ©/ØªØ¹Ù…ÙŠØ¯", en:"Special POA / Apostille"}
      ],
      hajj: [
        {ar:"Ø­Ø¬ Ø¨Ø§Ù‚Ø§Øª ÙƒØ§Ù…Ù„Ø©", en:"Hajj Packages"},
        {ar:"Ø¹Ù…Ø±Ø© ÙˆØªÙ†Ù‚Ù„Ø§Øª", en:"Umrah & Transport"},
        {ar:"Ø¥Ù‚Ø§Ù…Ø© ÙˆØ®Ø¯Ù…Ø§Øª", en:"Accommodation Services"}
      ],
      flights: [
        {ar:"ØªØ°Ø§ÙƒØ± Ø¯ÙˆÙ„ÙŠØ©", en:"International Tickets"},
        {ar:"ØªØ°Ø§ÙƒØ± Ø¯Ø§Ø®Ù„ÙŠØ©", en:"Domestic Tickets"},
        {ar:"ØªØ¹Ø¯ÙŠÙ„/Ø¥Ù„ØºØ§Ø¡", en:"Change/Cancel"},
        {ar:"Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØ¹ÙˆØ§Ø¦Ù„", en:"Groups & Families"}
      ]
    }
  },
  en: {
    ui: {
      title: "Smart Immigration Portal â€“ Alhijrah Visa & Immigration Services",
      tagline: "Welcome to the official platform â€” a complete, professional immigration experience.",
      countryLabel: "Country / Category",
      countryHint: "Pick a category then search or choose from the list. One smart form for all services.",
      searchLabel: "Search for a service",
      next: "Next â†’",
      formTitle: "Application Form",
      serviceBold: "Service:",
      fullName: "Full Name *",
      email: "Email *",
      phone: "Phone *",
      city: "City (optional)",
      citizenship: "Citizenship *",
      resident: "Resident Country *",
      details: "Additional Details (optional)",
      attach: "Attach Documents (optional)",
      phoneHint: "Formats + or 00 allowed, 8â€“15 digits.",
      photoLabel: "Passport Photo 600Ã—600 (auto)",
      bCam:"Start Camera", bShot:"Capture", bAnalyze:"Analyze/Enhance",
      photoHint: "* If browser blocks camera (HTTPS required), use manual upload.",
      back: "Back", reviewGo:"Review â†’",
      reviewTitle:"Review Submission",
      edit:"Edit", submit:"Submit",
      jotOpen:"Open Prefilled Jotform",
      jotHint:"Structured name (First/Last) enabled for Jotform prefill.",
      cardTitle:"Digital Client Card (VIP)",
      cTrack:"TrackID:", cService:"Service:", cSecure:"Secured",
      bPDF:"Download PDF", bWA:"Share via WhatsApp", bPrint:"Print",
      thanksTitle:"ğŸ‰ Thank you!", thanksDesc:"Your request was received. We'll review and contact you shortly.",
      load:"Preparing your dataâ€¦",
      fBrand:"Alhijrah Visa & Immigration Services",
      fTag:"Glass UI â€” VIP, secure and professional.",
      fContact:"Contact", fLinks:"Links", fBooking:"Bookings & Consultations", fHours:"Daily 10amâ€“6pm (EST)", fBook:"Book now", fEmailUs:"Email us",
      svcEmpty:"Services will appear after selecting a category or typing a searchâ€¦",
      svcNoMatch:"No matching services.",
      chooseFirst:"Choose a category first.",
      chooseService:"Pick a service from the list.",
      checkRequired:"Please verify name, email, phone, citizenship, and resident country.",
      toastChosen:"Selected service: ",
      ticker: [
        "USCIS family & employment services",
        "US & Yemen passports",
        "Green cards & renewals",
        "Embassy appointments & visas",
        "Legal translation, notarization, POA",
        "Flight bookings & travel insurance",
        "Legal consultations â€” VIP"
      ]
    },
    services: {} // uses Arabic lists but displays en names
  }
};

/* ================= Data & State ================= */
const MAX_FILE = 5*1024*1024;
const OK_EXT = ['pdf','doc','docx','jpg','jpeg','png'];

let LANG = 'ar';
let selectedService = null;

/* ================= Elements (with safe getters) ================= */
const $ = (id)=>document.getElementById(id);
const yr = $('yr'); yr.textContent = new Date().getFullYear();

const bar = $('bar');
const step1 = $('step1'), step2 = $('step2'), step3 = $('step3');
const country = $('country'), svcSearch = $('svcSearch'), svcBox = $('svcBox'), svcList = $('svcList'), svcMuted = $('svcMuted'), next1 = $('next1');

const fullName = $('fullName'), email = $('email'), phone = $('phone'), city = $('city'),
      citizenship = $('citizenship'), residentCountry = $('residentCountry'),
      details = $('details'), files = $('files'), fileList = $('fileList'), fileMeta = $('fileMeta'),
      prev2 = $('prev2'), next2 = $('next2');

const svcNamePill = $('svcNamePill'), reqDocs = $('reqDocs');
const reviewBox = $('reviewBox'), prev3 = $('prev3'), submitBtn = $('submit');

const clientCard = $('clientCard'), trackIdEl=$('trackId'), svcOut=$('svcOut'),
      qrcodeEl=$('qrcode'), cardData=$('cardData'), dlPDF=$('dlPDF'), dlWord=$('dlWord'), waShare=$('waShare'), printCard=$('printCard');

const toast = $('toast');
const thanksWrap = $('thanksWrap'), btnViewCard=$('btnViewCard'), btnCloseThanks=$('btnCloseThanks');
const loading = $('loading'), loadingText = $('loadingText');

/* Language-controlled elements */
const langSel = $('lang');
const L = (k)=>TEXT[LANG].ui[k];

/* ================= Language Switch ================= */
function applyLang(){
  document.documentElement.lang = LANG;
  document.documentElement.dir = (LANG==='ar'?'rtl':'ltr');

  // Head title fix
  document.title = L('title');

  // Labels & texts
  $('title').textContent = L('title'); // H1
  $('tagline').textContent = L('tagline');
  $('labelCountry').textContent = L('countryLabel');
  $('hintCountry').textContent = L('countryHint');
  $('labelSearch').textContent = L('searchLabel');
  next1.textContent = L('next');

  $('formTitle').textContent = L('formTitle');
  $('labelServiceBold').textContent = L('serviceBold');
  $('labelFullName').textContent = L('fullName');
  $('labelEmail').textContent = L('email');
  $('labelPhone').textContent = L('phone');
  $('labelCity').textContent = L('city');
  $('labelCitizenship').textContent = L('citizenship');
  $('labelResident').textContent = L('resident');
  $('labelDetails').textContent = L('details');
  $('labelFiles').textContent = L('attach');
  $('hintPhone').textContent = L('phoneHint');
  $('labelPhoto').textContent = L('photoLabel');
  $('bCam').textContent = L('bCam');
  $('bShot').textContent = L('bShot');
  $('bAnalyze').textContent = L('bAnalyze');
  $('photoHint').textContent = L('photoHint');

  $('prev2').textContent = L('back');
  $('next2').textContent = L('reviewGo');

  $('reviewTitle').textContent = L('reviewTitle');
  $('prev3').textContent = L('edit');
  $('submit').textContent = L('submit');
  $('bJotOpen').textContent = L('jotOpen');
  $('jotHint').textContent = L('jotHint');

  $('cardTitle').textContent = L('cardTitle');
  $('cTrack').textContent = L('cTrack');
  $('cService').textContent = L('cService');
  $('cSecure').textContent = L('cSecure');
  $('bPDF').textContent = L('bPDF');
  $('bWA').textContent = L('bWA');
  $('bPrint').textContent = L('bPrint');
  $('bWord').textContent = (LANG==='ar'?'ØªÙ†Ø²ÙŠÙ„ Word':'Download Word');

  $('thanksTitle').textContent = L('thanksTitle');
  $('thanksDesc').textContent = L('thanksDesc');
  $('loadingText').textContent = L('load');

  $('fBrand').textContent = L('fBrand');
  $('fTag').textContent = L('fTag');
  $('fContact').textContent = L('fContact');
  $('fLinks').textContent = L('fLinks');
  $('fBooking').textContent = L('fBooking');
  $('fHours').textContent = L('fHours');
  $('fBook').textContent = L('fBook');
  $('fEmailUs').textContent = L('fEmailUs');

  svcMuted.textContent = L('svcEmpty');

  // fill ticker
  const tags = L('ticker');
  $('tickerLine').innerHTML = tags.concat(tags).map(t => `<span class="tag"><i class="fa-solid fa-star-of-life"></i> ${t}</span>`).join('');

  // refresh services list
  renderServices();
}
langSel.addEventListener('change', ()=>{ LANG = langSel.value; applyLang(); });

/* ================= Services ================= */
function getServicesForCountry(){
  const c = country.value;
  if(!c) return [];
  const arr = TEXT.ar.services[c] || [];
  return arr.map(s => ({ n: (LANG==='ar' ? s.ar : s.en), req: [] }));
}
function renderServices(){
  const list = getServicesForCountry();
  const q = (svcSearch.value||'').trim().toLowerCase();
  let filt = list;
  if(q){ filt = list.filter(s => s.n.toLowerCase().includes(q)); }
  svcList.innerHTML = '';
  if(!country.value){ svcMuted.textContent = L('svcEmpty'); return; }
  if(filt.length===0){ svcMuted.textContent = L('svcNoMatch'); return; }
  svcMuted.textContent = '';
  filt.forEach(s=>{
    const row = document.createElement('div'); row.className='svc';
    const span = document.createElement('span'); span.textContent = s.n;
    const btn = document.createElement('button'); btn.className='btn sec'; btn.textContent=(LANG==='ar'?'Ø§Ø®ØªÙŠØ§Ø±':'Select');
    btn.onclick = ()=> selectService(s);
    row.append(span, btn);
    svcList.appendChild(row);
  });
}
country.addEventListener('change', renderServices);
svcSearch.addEventListener('input', debounce(renderServices, 200));

function selectService(svc){
  selectedService = svc;
  $('svcNamePill').textContent = svc.n;
  $('reqDocs').innerHTML = "";
  setStep(1);
  showToast(L('toastChosen') + svc.n);
}

/* ================= Navigation & Validation ================= */
function setStep(i){
  const steps=[step1,step2,step3];
  steps.forEach((s,idx)=> s.style.display = idx===i ? 'block' : 'none');
  bar.style.width = (i/(steps.length-1))*100 + '%';
  window.scrollTo({top:0,behavior:'smooth'});
}
$('next1').addEventListener('click', ()=>{
  if(!country.value){ showToast(L('chooseFirst')); return; }
  if(!selectedService){ showToast(L('chooseService')); return; }
  setStep(1);
});
$('prev2').addEventListener('click', ()=> setStep(0));
$('next2').addEventListener('click', ()=>{
  if(!v('fullName') || !($('email')?.validity?.valid) || !phoneValid(v('phone')) || !v('citizenship') || !v('residentCountry')){
    showToast(L('checkRequired'));
    return;
  }
  buildReview();
  setStep(2);
});
$('prev3').addEventListener('click', ()=> setStep(1));

function v(id){ const el=$(id); return (el && typeof el.value==='string') ? el.value.trim() : ""; }
function phoneValid(val){ return /^(\+|00)?\d{8,15}$/.test((val||'').trim()); }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ================= Review ================= */
function buildReview(){
  const det = esc(v('details')).replace(/\n/g,'<br>');
  const fileNames = [...(files?.files||[])].map(f=>`<li>${esc(f.name)}</li>`).join('');
  const filesHTML = (files && files.files && files.files.length) ? `<ul>${fileNames}</ul>` : (LANG==='ar'?'Ù„Ø§ ÙŠÙˆØ¬Ø¯':'None');
  reviewBox.innerHTML = `
    <p><b>${L('serviceBold')}</b> ${esc(selectedService?.n||'â€”')}</p>
    <p><b>${L('fullName').replace(' *','')}:</b> ${esc(v('fullName'))}</p>
    <p><b>${L('email').replace(' *','')}:</b> ${esc(v('email'))}</p>
    <p><b>${L('phone').replace(' *','')}:</b> ${esc(v('phone'))}</p>
    <p><b>${L('city').replace(' (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)','').replace(' (optional)','')}:</b> ${esc(v('city')||'-')}</p>
    <p><b>${L('citizenship').replace(' *','')}:</b> ${esc(v('citizenship'))}</p>
    <p><b>${L('resident').replace(' *','')}:</b> ${esc(v('residentCountry'))}</p>
    <p><b>${L('details').replace(' (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)','').replace(' (optional)','')}:</b></p><div>${det|| (LANG==='ar'?'Ù„Ø§ ÙŠÙˆØ¬Ø¯':'None')}</div>
    <p><b>${L('attach').replace(' (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)','').replace(' (optional)','')}:</b> ${filesHTML}</p>
  `;
  $('btnJotPrefill').href = buildJotPrefillURL();
  $('btnJotTable').href   = INTEGRATIONS.JOTFORM.TABLE_URL;
  $('btnJotBoard').href   = INTEGRATIONS.JOTFORM.BOARD_URL;
}

/* ================= Submit ================= */
$('submit').addEventListener('click', async ()=>{
  const track = makeTrackId();
  thanksWrap.style.display='block';
  showClientCard(track);
  loadingOn();

  try{
    const payload = buildPayload(track);
    await fireIntegrations(payload);
  }catch(e){
    console.warn('Integrations error', e);
    showToast((LANG==='ar'?'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.':'Some data could not be sent.'));
  }finally{
    loadingOff();
  }
});
$('btnViewCard').onclick = ()=>{ thanksWrap.style.display='none'; clientCard.scrollIntoView({behavior:'smooth', block:'center'}); };
$('btnCloseThanks').onclick = ()=>{ thanksWrap.style.display='none'; };

function makeTrackId(){
  const d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  return `ALH-${y}${m}${dd}-${Math.floor(Math.random()*9000+1000)}`;
}

/* ================= Client Card ================= */
function showClientCard(track){
  trackIdEl.textContent = track;
  svcOut.textContent = selectedService?.n || 'â€”';

  const qrText = location.origin + location.pathname + '?track=' + encodeURIComponent(track);
  qrcodeEl.innerHTML = ''; new QRCode(qrcodeEl, {text:qrText, width:120, height:120, colorDark:"#000", colorLight:"#fff"});

  cardData.innerHTML = `
    <div class="footer-box">
      <p><b>${L('fullName').replace(' *','')}:</b> ${esc(v('fullName'))}</p>
      <p><b>${L('citizenship').replace(' *','')}:</b> ${esc(v('citizenship'))}</p>
      <p><b>${L('resident').replace(' *','')}:</b> ${esc(v('residentCountry'))}</p>
    </div>
    <div class="footer-box">
      <p><b>${L('email').replace(' *','')}:</b> ${esc(v('email'))}</p>
      <p><b>${L('phone').replace(' *','')}:</b> ${esc(v('phone'))}</p>
      <p><b>${L('city').replace(' (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)','').replace(' (optional)','')}:</b> ${esc(v('city')||'-')}</p>
      <p><b>${LANG==='ar'?'Ø§Ù„ØªØ§Ø±ÙŠØ®':'Date'}:</b> ${new Date().toLocaleDateString(LANG==='ar'?'ar':'en')}</p>
    </div>
  `;

  clientCard.style.display = 'block';
  waShare.href = `https://wa.me/13139194272?text=${encodeURIComponent('TrackID '+track+' â€” '+(v('fullName')||'')+' â€” '+(selectedService?.n||''))}`;
  dlPDF.onclick = ()=> html2pdf().from(clientCard).set({margin:.4, filename:`ClientCard_${track}.pdf`, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a4'}}).save();
  dlWord.onclick = ()=> downloadWordFromCard(track);
  printCard.onclick = ()=> window.print();
}

/* ======= Word (.doc) export (HTML-in-DOC, opens in Microsoft Word) ======= */
function downloadWordFromCard(track){
  // Build a minimal, RTL-aware HTML doc for Word
  const html = `
<!DOCTYPE html><html ${LANG==='ar'?'lang="ar" dir="rtl"':'lang="en" dir="ltr"'}>
<head><meta charset="utf-8"><title>Client Card ${track}</title></head>
<body>
  <h2>${esc(L('cardTitle'))}</h2>
  <div>${clientCard.querySelector('.inner').innerHTML}</div>
  <hr/>
  <p><small>Generated from Alhijrah Smart Portal â€” TrackID: ${esc(track)}</small></p>
</body></html>`;
  const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ClientCard_${track}.doc`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 800);
}

/* ================= Jotform Prefill (kept for future) ================= */
function splitNameSmart(full){
  const clean = (full||"").trim().replace(/\s+/g,' ');
  if(!clean) return {first:"", last:""};
  const parts = clean.split(' ');
  if(parts.length===1) return {first:parts[0], last:""};
  return {first:parts[0], last:parts.slice(1).join(' ')};
}
function buildJotPrefillURL(track){
  const params = new URLSearchParams();
  const F = INTEGRATIONS.JOTFORM.FIELD_MAP || {};
  const full = v('fullName');
  const {first, last} = splitNameSmart(full);
  const trySet = (key, val) => { if(key && val!=null) params.set(key, val); };

  if (F["name[first]"]) trySet("name[first]", first);
  if (F["name[last]"])  trySet("name[last]",  last);

  if (F.email)            trySet(F.email,            v('email'));
  if (F.phone)            trySet(F.phone,            v('phone'));
  if (F.city)             trySet(F.city,             v('city'));
  if (F.service)          trySet(F.service,          selectedService?.n || "");
  if (F.citizenship)      trySet(F.citizenship,      v('citizenship'));
  if (F.resident_country) trySet(F.resident_country, v('residentCountry'));
  if (F.trackId && track) trySet(F.trackId,          track);

  return `${INTEGRATIONS.JOTFORM.FORM_URL}?${params.toString()}`;
}

/* ================= Google Sheets payload ================= */
function nowDetroitTimestamp() {
  const dt = new Date().toLocaleString('en-US', {
    timeZone: 'America/Detroit',
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', second: '2-digit',
    hour12: false
  });
  const [m,d,yAndTime] = dt.split('/');
  const [y, rest] = yAndTime.split(', ');
  return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')} ${rest}`;
}
function makeSubmissionId() {
  try { return crypto.randomUUID(); } catch(_) {
    return 'sub_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
  }
}
function buildPayload(track){
  const submission_id = makeSubmissionId();
  const payload = {
    timestamp: nowDetroitTimestamp(),
    track_id: track,
    service: selectedService?.n || '',
    country: country.value || '',
    fullName: v('fullName'),
    email: v('email'),
    phone: v('phone'),
    city: v('city'),
    citizenship: v('citizenship'),
    resident_country: v('residentCountry'),
    details: v('details'),
    files_count: (files && files.files ? files.files.length : 0),
    track_url: location.href,
    submission_id
  };
  buildPayload._last = payload;
  return payload;
}

/* ================= Integrations ================= */
async function fireIntegrations(payload){
  // EmailJS â€” optional
  try{
    if(window.emailjs && INTEGRATIONS.EMAILJS.PUBLIC_KEY){
      emailjs.init(INTEGRATIONS.EMAILJS.PUBLIC_KEY);
      const params = {
        ...payload,
        to_email: INTEGRATIONS.EMAILJS.TO_EMAIL,
        reply_to: payload.email,
        from_name: payload.fullName
      };
      await emailjs.send(INTEGRATIONS.EMAILJS.SERVICE_ID, INTEGRATIONS.EMAILJS.TEMPLATE_ID, params);
    }
  }catch(e){
    console.warn('[EmailJS] fail', e);
    showToast(LANG==='ar'?'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯.':'Email could not be sent.');
  }

  // Google Sheets via Apps Script
  try{
    if(INTEGRATIONS.APPS_SCRIPT.ENDPOINT){
      const res = await fetch(INTEGRATIONS.APPS_SCRIPT.ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload),
        redirect: 'follow'
      });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok || !data?.ok){
        showToast(LANG==='ar'?'ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ Google Sheets':'Failed to save to Google Sheets');
      } else if (data.submission_id) {
        buildPayload._last.submission_id = data.submission_id;
      }
    }
  }catch(e){
    console.warn('[GAS] fail', e);
    showToast(LANG==='ar'?'ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ Google Sheets':'Failed to save to Google Sheets');
  }
}

/* ================= Files ================= */
files?.addEventListener('change', ()=>{
  fileList.innerHTML = '';
  let total = 0; let ok = true;
  [...(files.files||[])].forEach(f=>{
    const ext = (f.name.split('.').pop()||'').toLowerCase();
    total += f.size;
    if(!OK_EXT.includes(ext) || f.size>MAX_FILE) ok=false;
    const chip = document.createElement('div'); chip.className='file';
    chip.textContent = `${f.name} â€” ${(f.size/1024).toFixed(0)} KB`;
    fileList.appendChild(chip);
  });
  fileMeta.textContent = (files.files && files.files.length)
    ? ((LANG==='ar'?'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: ':'Files: ') + files.files.length + ' â€” ' + (LANG==='ar'?'Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒÙ„ÙŠ ~ ':'Total ~ ') + (total/1024/1024).toFixed(2) + ' MB')
    : (LANG==='ar'?'Ù„Ù… ÙŠØªÙ… Ø¥Ø±ÙØ§Ù‚ Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯.':'No files attached.');
  if(!ok) showToast(LANG==='ar'?'ØªØ­Ø°ÙŠØ±: Ù†ÙˆØ¹/Ø­Ø¬Ù… Ù…Ù„Ù ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­.':'Warning: invalid file type/size.');
});

/* ================= Smart Photo Capture (600Ã—600, face-aware) ================= */
const avatarInput = $('avatarInput'),
      btnCamStart = $('btnCamStart'),
      btnCamShot  = $('btnCamShot'),
      btnAnalyze  = $('btnAnalyze'),
      cam         = $('cam'),
      photoCanvas = $('photoCanvas'),
      photoReport = $('photoReport');

let stream = null, avatarDataURL = "";
let faceDetector = null;

if ('FaceDetector' in window) {
  try { faceDetector = new window.FaceDetector({ fastMode: true, maxDetectedFaces: 1 }); } catch (_) { faceDetector = null; }
}

function setCanvasSize(canvas, w, h) {
  const dpr = window.devicePixelRatio || 1;
  canvas.width  = Math.round(w * dpr);
  canvas.height = Math.round(h * dpr);
  canvas.style.width  = `${w}px`;
  canvas.style.height = `${h}px`;
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  return ctx;
}
function avgLuminance(ctx, w, h, stride = 6) {
  const data = ctx.getImageData(0, 0, w, h).data;
  let lum = 0, count = 0;
  for (let y = 0; y < h; y += stride) {
    for (let x = 0; x < w; x += stride) {
      const i = (y * w + x) * 4;
      lum += 0.2126 * data[i] + 0.7152 * data[i+1] + 0.0722 * data[i+2];
      count++;
    }
  }
  return lum / count;
}
async function toSquare600Smart(source, mirrored = false) {
  const OUT = 600;
  const ctxOut = setCanvasSize(photoCanvas, OUT, OUT);

  const srcW = source.videoWidth || source.naturalWidth || source.width;
  const srcH = source.videoHeight || source.naturalHeight || source.height;

  let crop = null;

  if (faceDetector && srcW && srcH) {
    try {
      const tmp = document.createElement('canvas');
      tmp.width = srcW; tmp.height = srcH;
      const tctx = tmp.getContext('2d');

      if (mirrored) { tctx.translate(srcW, 0); tctx.scale(-1, 1); }
      tctx.drawImage(source, 0, 0, srcW, srcH);

      const bitmap = await createImageBitmap(tmp);
      const faces = await faceDetector.detect(bitmap);
      if (faces && faces.length) {
        const f = faces[0].boundingBox;
        const pad = Math.max(f.width, f.height) * 0.4;
        const cx = f.x + f.width / 2;
        const cy = f.y + f.height / 2;
        let side = Math.max(f.width, f.height) + pad * 2;

        let sx = Math.max(0, Math.round(cx - side / 2));
        let sy = Math.max(0, Math.round(cy - side / 2));
        if (sx + side > srcW) sx = Math.max(0, Math.round(srcW - side));
        if (sy + side > srcH) sy = Math.max(0, Math.round(srcH - side));

        side = Math.min(side, srcW, srcH);
        crop = { sx, sy, sw: Math.round(side), sh: Math.round(side) };

        const faceAreaPct = (f.width * f.height) / (srcW * srcH);
        if (faceAreaPct < 0.03) crop = null;
      }
    } catch (_) { crop = null; }
  }

  if (!crop) {
    const sw = Math.min(srcW, srcH);
    const sx = Math.round((srcW - sw) / 2);
    const sy = Math.round((srcH - sw) / 2);
    crop = { sx, sy, sw, sh: sw };
  }

  ctxOut.fillStyle = '#fff';
  ctxOut.fillRect(0, 0, OUT, OUT);
  ctxOut.drawImage(source, crop.sx, crop.sy, crop.sw, crop.sh, 0, 0, OUT, OUT);

  const luminance = avgLuminance(ctxOut, OUT, OUT);
  avatarDataURL = photoCanvas.toDataURL('image/jpeg', 0.92);
  $('avatar').src = avatarDataURL;
  photoCanvas.style.display = 'block';

  const brightOK = luminance > 95;
  photoReport.textContent =
    (brightOK
      ? (LANG==='ar' ? "âœ… Ø¥Ø¶Ø§Ø¡Ø© Ø¬ÙŠØ¯Ø© â€“ ØªØ­ÙˆÙŠÙ„ 600Ã—600" : "âœ… Good lighting â€“ 600Ã—600")
      : (LANG==='ar' ? "âš ï¸ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© Ù…Ù†Ø®ÙØ¶Ø© â€“ ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ 600Ã—600" : "âš ï¸ Low lighting â€“ 600Ã—600")
    ) + (faceDetector ? (LANG==='ar' ? " | ÙƒØ´Ù ÙˆØ¬Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ" : " | Face auto-centered") : "");
  btnAnalyze.disabled = false;
}

avatarInput?.addEventListener('change', (e) => {
  const f = e.target.files?.[0];
  if (!f) return;
  const img = new Image();
  img.onload = () => toSquare600Smart(img, false);
  img.onerror = () => showToast(LANG==='ar'?'ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©.':'Could not read image.');
  img.src = URL.createObjectURL(f);
});

async function startCamera() {
  try {
    btnCamStart.disabled = true;
    const constraints = {
      video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 1280 }, aspectRatio: { ideal: 1 }, frameRate: { ideal: 30 } },
      audio: false
    };
    if (!navigator.mediaDevices?.getUserMedia) throw new Error('MediaDevices not supported');
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    cam.srcObject = stream;

    await new Promise((res, rej) => {
      cam.onloadedmetadata = () => cam.play().then(res).catch(rej);
      setTimeout(() => (cam.videoWidth>0?res():rej(new Error('Video not ready'))), 1500);
    });

    cam.style.display = 'block';
    btnCamShot.disabled = false;
  } catch (err) {
    console.warn(err);
    alert(LANG==='ar'
      ? 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ ÙˆÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± HTTPS.'
      : 'Cannot access camera. Make sure permissions are granted and page is HTTPS.');
    btnCamStart.disabled = false;
  }
}
function stopCamera() {
  try { stream?.getTracks()?.forEach(t => t.stop()); } catch(_) {}
  cam.pause(); cam.srcObject = null; cam.style.display = 'none';
  btnCamShot.disabled = true; btnCamStart.disabled = false;
}
btnCamStart?.addEventListener('click', startCamera);

btnCamShot?.addEventListener('click', async () => {
  if (!stream || cam.videoWidth === 0) {
    alert(LANG==='ar'?'Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ø¬Ø§Ù‡Ø².':'Video not ready.');
    return;
  }
  const vw = cam.videoWidth, vh = cam.videoHeight;
  const shot = document.createElement('canvas');
  shot.width = vw; shot.height = vh;
  const sctx = shot.getContext('2d');
  // Unmirror saved frame (preview mirrored via CSS)
  sctx.translate(vw, 0);
  sctx.scale(-1, 1);
  sctx.drawImage(cam, 0, 0, vw, vh);

  const img = new Image();
  img.onload = async () => { await toSquare600Smart(img, false); stopCamera(); };
  img.src = shot.toDataURL('image/jpeg', 0.92);
});

btnAnalyze?.addEventListener('click', () => {
  if (!avatarDataURL) {
    photoReport.textContent = (LANG==='ar' ? 'Ø­Ù…Ù‘Ù„ Ø£Ùˆ Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© Ø£ÙˆÙ„Ù‹Ø§.' : 'Upload or capture a photo first.');
    return;
  }
  photoReport.textContent += (LANG==='ar' ? ' | ÙØ­Øµ Ø³Ø±ÙŠØ¹ âœ…' : ' | Quick check âœ…');
});

/* ================= UI helpers ================= */
function showToast(msg, ms=2400){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',ms); }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

/* ================= Init ================= */
applyLang();
setStep(0);
renderServices();
</script>
</body>
</html>
